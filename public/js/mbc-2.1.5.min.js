/**
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Mobile Browser Capture
 * @website http://www.dynamsoft.com
 * @preserve Copyright 2019, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 2.1.4
 * @fileoverview Dynamsoft JavaScript Library for Basic Image Edit
 * More info on MBC: http://www.dynamsoft.com/
 */
var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(c,a,b){if(b.get||b.set)throw new TypeError("ES3 does not support getters and setters.");c!=Array.prototype&&c!=Object.prototype&&(c[a]=b.value)};$jscomp.getGlobal=function(c){return"undefined"!=typeof window&&window===c?c:"undefined"!=typeof global&&null!=global?global:c};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(c){return $jscomp.SYMBOL_PREFIX+(c||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var c=$jscomp.global.Symbol.iterator;c||(c=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[c]&&$jscomp.defineProperty(Array.prototype,c,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(c){var a=0;return $jscomp.iteratorPrototype(function(){return a<c.length?{done:!1,value:c[a++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(c){$jscomp.initSymbolIterator();c={next:c};c[$jscomp.global.Symbol.iterator]=function(){return this};return c};$jscomp.makeIterator=function(c){$jscomp.initSymbolIterator();var a=c[Symbol.iterator];return a?a.call(c):$jscomp.arrayIterator(c)};
$jscomp.polyfill=function(c,a,b,h){if(a){b=$jscomp.global;c=c.split(".");for(h=0;h<c.length-1;h++){var r=c[h];r in b||(b[r]={});b=b[r]}c=c[c.length-1];h=b[c];a=a(h);a!=h&&null!=a&&$jscomp.defineProperty(b,c,{configurable:!0,writable:!0,value:a})}};$jscomp.EXPOSE_ASYNC_EXECUTOR=!0;$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(c){function a(){this.batch_=null}if(c&&!$jscomp.FORCE_POLYFILL_PROMISE)return c;a.prototype.asyncExecute=function(a){null==this.batch_&&(this.batch_=[],this.asyncExecuteBatch_());this.batch_.push(a);return this};a.prototype.asyncExecuteBatch_=function(){var a=this;this.asyncExecuteFunction(function(){a.executeBatch_()})};var b=$jscomp.global.setTimeout;a.prototype.asyncExecuteFunction=function(a){b(a,0)};a.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var a=
this.batch_;this.batch_=[];for(var b=0;b<a.length;++b){var c=a[b];delete a[b];try{c()}catch(v){this.asyncThrow_(v)}}}this.batch_=null};a.prototype.asyncThrow_=function(a){this.asyncExecuteFunction(function(){throw a;})};var h=function(a){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var b=this.createResolveAndReject_();try{a(b.resolve,b.reject)}catch(V){b.reject(V)}};h.prototype.createResolveAndReject_=function(){function a(a){return function(d){c||(c=!0,a.call(b,d))}}var b=this,c=
!1;return{resolve:a(this.resolveTo_),reject:a(this.reject_)}};h.prototype.resolveTo_=function(a){if(a===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(a instanceof h)this.settleSameAsPromise_(a);else{var b;a:switch(typeof a){case "object":b=null!=a;break a;case "function":b=!0;break a;default:b=!1}b?this.resolveToNonPromiseObj_(a):this.fulfill_(a)}};h.prototype.resolveToNonPromiseObj_=function(a){var b=void 0;try{b=a.then}catch(V){this.reject_(V);return}"function"==
typeof b?this.settleSameAsThenable_(b,a):this.fulfill_(a)};h.prototype.reject_=function(a){this.settle_(2,a)};h.prototype.fulfill_=function(a){this.settle_(1,a)};h.prototype.settle_=function(a,b){if(0!=this.state_)throw Error("Cannot settle("+a+", "+b|"): Promise already settled in state"+this.state_);this.state_=a;this.result_=b;this.executeOnSettledCallbacks_()};h.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var a=this.onSettledCallbacks_,b=0;b<a.length;++b)a[b].call(),
a[b]=null;this.onSettledCallbacks_=null}};var r=new a;h.prototype.settleSameAsPromise_=function(a){var b=this.createResolveAndReject_();a.callWhenSettled_(b.resolve,b.reject)};h.prototype.settleSameAsThenable_=function(a,b){var c=this.createResolveAndReject_();try{a.call(b,c.resolve,c.reject)}catch(v){c.reject(v)}};h.prototype.then=function(a,b){function c(a,b){return"function"==typeof a?function(b){try{v(a(b))}catch(y){d(y)}}:b}var v,d,u=new h(function(a,b){v=a;d=b});this.callWhenSettled_(c(a,v),
c(b,d));return u};h.prototype["catch"]=function(a){return this.then(void 0,a)};h.prototype.callWhenSettled_=function(a,b){function c(){switch(h.state_){case 1:a(h.result_);break;case 2:b(h.result_);break;default:throw Error("Unexpected state: "+h.state_);}}var h=this;null==this.onSettledCallbacks_?r.asyncExecute(c):this.onSettledCallbacks_.push(function(){r.asyncExecute(c)})};h.resolve=function(a){return a instanceof h?a:new h(function(b,c){b(a)})};h.reject=function(a){return new h(function(b,c){c(a)})};
h.race=function(a){return new h(function(b,c){for(var v=$jscomp.makeIterator(a),d=v.next();!d.done;d=v.next())h.resolve(d.value).callWhenSettled_(b,c)})};h.all=function(a){var b=$jscomp.makeIterator(a),c=b.next();return c.done?h.resolve([]):new h(function(a,d){function u(b){return function(c){e[b]=c;v--;0==v&&a(e)}}var e=[],v=0;do e.push(void 0),v++,h.resolve(c.value).callWhenSettled_(u(e.length-1),d),c=b.next();while(!c.done)})};$jscomp.EXPOSE_ASYNC_EXECUTOR&&(h.$jscomp$new$AsyncExecutor=function(){return new a});
return h},"es6-impl","es3");$jscomp.findInternal=function(c,a,b){c instanceof String&&(c=String(c));for(var h=c.length,r=0;r<h;r++){var S=c[r];if(a.call(b,S,r,c))return{i:r,v:S}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(c){return c?c:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6-impl","es3");$jscomp.polyfill("Math.sign",function(c){return c?c:function(a){a=Number(a);return 0===a||isNaN(a)?a:0<a?1:-1}},"es6-impl","es3");
$jscomp.polyfill("Array.prototype.fill",function(c){return c?c:function(a,b,c){var h=this.length||0;0>b&&(b=Math.max(0,h+b));if(null==c||c>h)c=h;c=Number(c);0>c&&(c=Math.max(0,h+c));for(b=Number(b||0);b<c;b++)this[b]=a;return this}},"es6-impl","es3");var kUtil=kUtil||{};Math.sign||(Math.sign=function(c){return 0<c?1:0==c?0>1/c?-0:0:0>c?-1:NaN});kUtil.Matrix=function(c,a,b,h,r,S){this.a=c;this.b=a;this.c=b;this.d=h;this.e=r;this.f=S};
kUtil.Matrix.dot=function(c,a){return new kUtil.Matrix(c.a*a.a+c.c*a.b,c.b*a.a+c.d*a.b,c.a*a.c+c.c*a.d,c.b*a.c+c.d*a.d,c.a*a.e+c.c*a.f+c.e,c.b*a.e+c.d*a.f+c.f)};kUtil.Matrix.prototype.dot=function(c){return kUtil.Matrix.dot(this,c)};kUtil.Matrix.equals=function(c,a){return c.a==a.a&&c.b==a.b&&c.c==a.c&&c.d==a.d&&c.e==a.e&&c.f==a.f};kUtil.Matrix.prototype.equals=function(c){return kUtil.Matrix.equals(this,c)};
kUtil.Matrix.prototype.inversion=function(){var c=this.a,a=this.b,b=this.c,h=this.d,r=this.e,S=this.f,x=c*h-a*b;return new kUtil.Matrix(h/x,-a/x,-b/x,c/x,(b*S-h*r)/x,(a*r-c*S)/x)};kUtil.convertURLToBlob=function(c,a){var b=new XMLHttpRequest;b.open("GET",c,!0);b.responseType="blob";b.onloadend=function(){a(this.response)};b.send()};kUtil.convertBase64ToBlob=function(c,a){for(var b=atob(c),h=Array(b.length),r=0;r<b.length;++r)h[r]=b.charCodeAt(r);b=new Uint8Array(h);return new Blob([b],{type:a})};
Date.prototype.kUtilFormat=function(c){var a={"M+":this.getUTCMonth()+1,"d+":this.getUTCDate(),"h+":this.getUTCHours(),"m+":this.getUTCMinutes(),"s+":this.getUTCSeconds(),"q+":Math.floor((this.getUTCMonth()+3)/3),S:this.getUTCMilliseconds()};/(y+)/.test(c)&&(c=c.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var b in a)(new RegExp("("+b+")")).test(c)&&(c=c.replace(RegExp.$1,1==RegExp.$1.length?a[b]:("00"+a[b]).substr((""+a[b]).length)));return c};
kUtil.copyToClipBoard=function(c){if(navigator.clipboard)navigator.clipboard.writeText(c)["catch"](function(a){alert("copy failed, info: "+(a.message||a))});else{var a=document.createElement("textarea");a.style.width="4px";a.style.height="4px";a.style.position="fixed";a.style.left="0";a.style.top="0";jQuery(document.body).append(a);a.value=c;if(c=navigator.userAgent.match(/ipad|iphone/i)){var b=document.createRange();b.selectNodeContents(a);var h=window.getSelection();h.removeAllRanges();h.addRange(b);
a.setSelectionRange(0,999999)}else a.focus(),a.select();try{document.execCommand("copy")||c||alert("copy failed")}catch(r){alert("copy failed, info: "+(r.message||r))}jQuery(a).remove()}};
(function(c){c.fn.borderWidth=function(){var a;a=window.getComputedStyle?getComputedStyle(this[0]):this[0].currentStyle;var b={};b.left=parseFloat(a.getPropertyValue?a.getPropertyValue("border-left-width"):a.getAttribute("border-left-width"))||0;b.top=parseFloat(a.getPropertyValue?a.getPropertyValue("border-top-width"):a.getAttribute("border-top-width"))||0;b.right=parseFloat(a.getPropertyValue?a.getPropertyValue("border-right-width"):a.getAttribute("border-right-width"))||0;b.bottom=parseFloat(a.getPropertyValue?
a.getPropertyValue("border-bottom-width"):a.getAttribute("border-bottom-width"))||0;return b};c.fn.padding=function(){var a;a=window.getComputedStyle?getComputedStyle(this[0]):this[0].currentStyle;var b={};b.left=parseFloat(a.getPropertyValue?a.getPropertyValue("padding-left"):a.getAttribute("padding-left"))||0;b.top=parseFloat(a.getPropertyValue?a.getPropertyValue("padding-top"):a.getAttribute("padding-top"))||0;b.right=parseFloat(a.getPropertyValue?a.getPropertyValue("padding-right"):a.getAttribute("padding-right"))||
0;b.bottom=parseFloat(a.getPropertyValue?a.getPropertyValue("padding-bottom"):a.getAttribute("padding-bottom"))||0;return b};c.fn.borderBoxRect=function(){var a=null;window.getComputedStyle&&(a=getComputedStyle(this[0]));var b=this.offset(),c={};c.pageX0=b.left;c.pageY0=b.top;c.width=a?parseFloat(a.width):this.outerWidth();c.height=a?parseFloat(a.height):this.outerHeight();c.pageX1=c.pageX0+c.width;c.pageY1=c.pageY0+c.height;return c};c.fn.paddingBoxRect=function(){var a=this.borderBoxRect(),b=this.borderWidth(),
c={};c.pageX0=a.pageX0+b.left;c.pageY0=a.pageY0+b.top;c.width=window.getComputedStyle?a.width-(b.left+b.right):this.innerWidth();c.height=window.getComputedStyle?a.height-(b.top+b.bottom):this.innerHeight();c.pageX1=a.pageX1-b.right;c.pageY1=a.pageY1-b.bottom;return c};c.fn.contentBoxRect=function(){var a=this.paddingBoxRect(),b=this.padding(),c={};c.pageX0=a.pageX0+b.left;c.pageY0=a.pageY0+b.top;c.width=window.getComputedStyle?a.width-(b.left+b.right):this.width();c.height=window.getComputedStyle?
a.height-(b.top+b.bottom):this.height();c.pageX1=a.pageX1-b.right;c.pageY1=a.pageY1-b.bottom;return c};c.fn.getTransform=function(){var a=this.css("transform");if("none"==a||""==a)a=this[0].style.transform;var b="matrix(",c=a.indexOf(b);if(-1!=c){c+=b.length;a=a.substring(c,a.indexOf(")",c)).split(",");for(b=0;b<a.length;++b)a[b]=parseFloat(a[b]);return new kUtil.Matrix(a[0],a[1],a[2],a[3],a[4],a[5])}b="scale(";c=a.indexOf(b);return-1!=c?(c+=b.length,a=parseFloat(a.substring(c)),new kUtil.Matrix(a,
0,0,a,0,0)):new kUtil.Matrix(1,0,0,1,0,0)};c.fn.setTransform=function(a){a="matrix("+[a.a,a.b,a.c,a.d,a.e,a.f].join()+")";this.css("transform",a)}})(jQuery);var TaskQueue=function(){this._queue=[];this.isWorking=!1;this.timeout=100};TaskQueue.prototype.push=function(c,a,b,h){this._queue.push({task:c,context:a,args:b,handleReturn:h});this.isWorking||this.next()};TaskQueue.prototype.unshift=function(c,a,b,h){this._queue.unshift({task:c,context:a,args:b,handleReturn:h});this.isWorking||this.next()};
TaskQueue.prototype.next=function(){if(0==this._queue.length)this.isWorking=!1;else{this.isWorking=!0;var c=this._queue.shift(),a=c.task,b=c.context?c.context:self,h=c.args?c.args:[],r=c.handleReturn;setTimeout(function(){var c=a.apply(b,h);"function"==typeof r&&r(c)},this.timeout)}};
(function(){function c(a,b){b||a.match(/^data\:([^\;]+)\;base64,/mi);a=a.replace(/^data\:([^\;]+)\;base64,/gmi,"");for(var c=atob(a),d=c.length,g=new ArrayBuffer(d),z=new Uint8Array(g),e=0;e<d;e++)z[e]=c.charCodeAt(e);return g}function a(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0);c.responseType="blob";c.onload=function(a){200!=this.status&&0!==this.status||b(this.response)};c.send()}function b(b,d){function g(a){var c=h(a),B;a:if(B=new DataView(a),255!=B.getUint8(0)||216!=B.getUint8(1))B=!1;
else{for(var t=2,g=a.byteLength;t<g;){var e=B,z=t;if(56===e.getUint8(z)&&66===e.getUint8(z+1)&&73===e.getUint8(z+2)&&77===e.getUint8(z+3)&&4===e.getUint8(z+4)&&4===e.getUint8(z+5)){e=B.getUint8(t+7);0!==e%2&&(e+=1);0===e&&(e=4);var g=t+8+e,t=B.getUint16(t+6+e),D,R;B=g;g=new DataView(a);e={};for(z=B;z<B+t;)28===g.getUint8(z)&&2===g.getUint8(z+1)&&(D=g.getUint8(z+2),D in O&&(R=g.getInt16(z+3),D=O[D],R=x(g,z+5,R),e.hasOwnProperty(D)?e[D]instanceof Array?e[D].push(R):e[D]=[e[D],R]:e[D]=R)),z++;B=e;break a}t++}B=
void 0}var Q;a:if("DOMParser"in self)if(t=new DataView(a),255!=t.getUint8(0)||216!=t.getUint8(1))Q=!1;else{g=2;e=a.byteLength;for(a=new DOMParser;g<e-4;)if("http"==x(t,g,4)){e=g-1;g=t.getUint16(g-2)-1;t=x(t,e,g);g=t.indexOf("xmpmeta>")+8;t=t.substring(t.indexOf("<x:xmpmeta"),g);g=t.indexOf("x:xmpmeta")+10;t=t.slice(0,g)+'xmlns:Iptc4xmpCore="http://iptc.org/std/Iptc4xmpCore/1.0/xmlns/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:tiff="http://ns.adobe.com/tiff/1.0/" xmlns:plus="http://schemas.android.com/apk/lib/com.google.android.gms.plus" xmlns:ext="http://www.gettyimages.com/xsltExtension/1.0" xmlns:exif="http://ns.adobe.com/exif/1.0/" xmlns:stEvt="http://ns.adobe.com/xap/1.0/sType/ResourceEvent#" xmlns:stRef="http://ns.adobe.com/xap/1.0/sType/ResourceRef#" xmlns:crs="http://ns.adobe.com/camera-raw-settings/1.0/" xmlns:xapGImg="http://ns.adobe.com/xap/1.0/g/img/" xmlns:Iptc4xmpExt="http://iptc.org/std/Iptc4xmpExt/2008-02-29/" '+
t.slice(g);b:{a=a.parseFromString(t,"text/xml");try{t={};if(0<a.children.length)for(g=0;g<a.children.length;g++){var u=a.children.item(g),v=u.attributes,w;for(w in v){var y=v[w],U=y.nodeName,H=y.nodeValue;void 0!==U&&(t[U]=H)}var n=u.nodeName;if("undefined"==typeof t[n])t[n]=xml2json(u);else{if("undefined"==typeof t[n].push){var p=t[n];t[n]=[];t[n].push(p)}t[n].push(xml2json(u))}}else t=a.textContent;Q=t;break b}catch(f){console.log(f.message)}Q=void 0}break a}else g++;Q=void 0}else Q=void 0;b.exifdata=
c||{};b.iptcdata=B||{};b.xmpdata=Q||{};d&&d.call(b)}if(b.src)if(/^data\:/i.test(b.src)){var z=c(b.src);g(z)}else if(/^blob\:/i.test(b.src)){var e=new FileReader;e.onload=function(a){g(a.target.result)};a(b.src,function(a){e.readAsArrayBuffer(a)})}else{var D=new XMLHttpRequest;D.onload=function(){if(200==this.status||0===this.status)g(D.response);else throw"Could not load image";D=null};D.open("GET",b.src,!0);D.responseType="arraybuffer";D.send(null)}else self.FileReader&&(b instanceof self.Blob||
b instanceof self.File)&&(e=new FileReader,e.onload=function(a){g(a.target.result)},e.readAsArrayBuffer(b))}function h(a){var b=new DataView(a);if(255!=b.getUint8(0)||216!=b.getUint8(1))return!1;var c=2;a=a.byteLength;for(var g;c<a;){if(255!=b.getUint8(c))return!1;g=b.getUint8(c+1);if(225==g)return V(b,c+4,b.getUint16(c+2)-2);c+=2+b.getUint16(c+2)}}function r(a,b,c,d,e){var g=a.getUint16(c,!e),z={},F,B,t;for(t=0;t<g;t++)F=c+12*t+2,B=d[a.getUint16(F,!e)],z[B]=S(a,F,b,c,e);return z}function S(a,b,c,
d,e){var g=a.getUint16(b+2,!e);d=a.getUint32(b+4,!e);c=a.getUint32(b+8,!e)+c;var h,F;switch(g){case 1:case 7:if(1==d)return a.getUint8(b+8,!e);c=4<d?c:b+8;b=[];for(g=0;g<d;g++)b[g]=a.getUint8(c+g);return b;case 2:return x(a,4<d?c:b+8,d-1);case 3:if(1==d)return a.getUint16(b+8,!e);c=2<d?c:b+8;b=[];for(g=0;g<d;g++)b[g]=a.getUint16(c+2*g,!e);return b;case 4:if(1==d)return a.getUint32(b+8,!e);b=[];for(g=0;g<d;g++)b[g]=a.getUint32(c+4*g,!e);return b;case 5:if(1==d)return h=a.getUint32(c,!e),F=a.getUint32(c+
4,!e),a=new Number(h/F),a.numerator=h,a.denominator=F,a;b=[];for(g=0;g<d;g++)h=a.getUint32(c+8*g,!e),F=a.getUint32(c+4+8*g,!e),b[g]=new Number(h/F),b[g].numerator=h,b[g].denominator=F;return b;case 9:if(1==d)return a.getInt32(b+8,!e);b=[];for(g=0;g<d;g++)b[g]=a.getInt32(c+4*g,!e);return b;case 10:if(1==d)return a.getInt32(c,!e)/a.getInt32(c+4,!e);b=[];for(g=0;g<d;g++)b[g]=a.getInt32(c+8*g,!e)/a.getInt32(c+4+8*g,!e);return b}}function x(a,b,c){for(var d="",g=b;g<b+c;g++)d+=String.fromCharCode(a.getUint8(g));
return d}function V(a,b){if("Exif"!=x(a,b,4))return!1;var c,d,g,h,z=b+6;if(18761==a.getUint16(z))c=!1;else if(19789==a.getUint16(z))c=!0;else return!1;if(42!=a.getUint16(z+2,!c))return!1;var F=a.getUint32(z+4,!c);if(8>F)return!1;d=r(a,z,z+F,e,c);if(d.ExifIFDPointer)for(g in h=r(a,z,z+d.ExifIFDPointer,u,c),h){switch(g){case "LightSource":case "Flash":case "MeteringMode":case "ExposureProgram":case "SensingMethod":case "SceneCaptureType":case "SceneType":case "CustomRendered":case "WhiteBalance":case "GainControl":case "Contrast":case "Saturation":case "Sharpness":case "SubjectDistanceRange":case "FileSource":h[g]=
y[g][h[g]];break;case "ExifVersion":case "FlashpixVersion":h[g]=String.fromCharCode(h[g][0],h[g][1],h[g][2],h[g][3]);break;case "ComponentsConfiguration":h[g]=y.Components[h[g][0]]+y.Components[h[g][1]]+y.Components[h[g][2]]+y.Components[h[g][3]]}d[g]=h[g]}if(d.GPSInfoIFDPointer)for(g in h=r(a,z,z+d.GPSInfoIFDPointer,C,c),h){switch(g){case "GPSVersionID":h[g]=h[g][0]+"."+h[g][1]+"."+h[g][2]+"."+h[g][3]}d[g]=h[g]}F=z+F;g=a.getUint16(F,!c);if(F=a.getUint32(F+2+12*g,!c))if(F>a.byteLength)z={};else{F=
r(a,z,z+F,w,c);if(F.Compression)switch(F.Compression){case 6:F.JpegIFOffset&&F.JpegIFByteCount&&(F.blob=new Blob([new Uint8Array(a.buffer,z+F.JpegIFOffset,F.JpegIFByteCount)],{type:"image/jpeg"}));break;case 1:console.log("Thumbnail image format is TIFF, which is not implemented.");break;default:console.log("Unknown thumbnail image format '%s'",F.Compression)}else 2==F.PhotometricInterpretation&&console.log("Thumbnail image format is RGB, which is not implemented.");z=F}else z={};d.thumbnail=z;return d}
var v=self,d=function(a){if(a instanceof d)return a;if(!(this instanceof d))return new d(a);this.EXIFwrapped=a};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=d),exports.EXIF=d):v.EXIF=d;var u=d.Tags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",
36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",
41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",
42016:"ImageUniqueID"},e=d.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",
301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"},C=d.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",
16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"},w=d.IFD1Tags={256:"ImageWidth",257:"ImageHeight",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",
278:"RowsPerStrip",279:"StripByteCounts",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",296:"ResolutionUnit",513:"JpegIFOffset",514:"JpegIFByteCount",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite"},y=d.StringValues={ExposureProgram:{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"},MeteringMode:{0:"Unknown",1:"Average",
2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",
24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",
32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",
95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},SensingMethod:{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},SceneType:{1:"Directly photographed"},CustomRendered:{0:"Normal process",1:"Custom process"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},
GainControl:{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},SubjectDistanceRange:{0:"Unknown",1:"Macro",2:"Close view",3:"Distant view"},FileSource:{3:"DSC"},Components:{0:"",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}},O={120:"caption",110:"credit",25:"keywords",55:"dateCreated",80:"byline",85:"bylineTitle",122:"captionWriter",
105:"headline",116:"copyright",15:"category"};d.getData=function(a,c){if((self.Image&&a instanceof self.Image||self.HTMLImageElement&&a instanceof self.HTMLImageElement)&&!a.complete)return!1;a.exifdata?c&&c.call(a):b(a,c);return!0};d.getTag=function(a,b){if(a.exifdata)return a.exifdata[b]};d.getIptcTag=function(a,b){if(a.exifdata)return a.iptcdata[b]};d.getAllTags=function(a){if(!a.exifdata)return{};var b;a=a.exifdata;var c={};for(b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c};d.getAllIptcTags=
function(a){if(!a.exifdata)return{};var b;a=a.iptcdata;var c={};for(b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c};d.pretty=function(a){if(!a.exifdata)return"";var b;a=a.exifdata;var c="";for(b in a)a.hasOwnProperty(b)&&(c="object"==typeof a[b]?a[b]instanceof Number?c+(b+" : "+a[b]+" ["+a[b].numerator+"/"+a[b].denominator+"]\r\n"):c+(b+" : ["+a[b].length+" values]\r\n"):c+(b+" : "+a[b]+"\r\n"));return c};d.readFromBinaryFile=function(a){return h(a)};"function"===typeof define&&define.amd&&define("exif-js",
[],function(){return d})}).call(this);
(function(c){function a(){for(var a=0;a<D.length;a++)D[a][0](D[a][1]);D=[];aa=!1}function b(b,c){D.push([b,c]);aa||(aa=!0,Q(a,0))}function h(a,b){function c(a){x(b,a)}function B(a){v(b,a)}try{a(c,B)}catch(ba){B(ba)}}function r(a){var b=a.owner,c=b.state_,b=b.data_,d=a[c];a=a.then;if("function"===typeof d){c=z;try{b=d(b)}catch(ba){v(a,ba)}}S(a,b)||(c===z&&x(a,b),c===R&&v(a,b))}function S(a,b){var c;try{if(a===b)throw new TypeError("A promises callback cannot return that same promise.");if(b&&("function"===
typeof b||"object"===typeof b)){var d=b.then;if("function"===typeof d)return d.call(b,function(d){c||(c=!0,b!==d?x(a,d):V(a,d))},function(b){c||(c=!0,v(a,b))}),!0}}catch(ba){return c||v(a,ba),!0}return!1}function x(a,b){a!==b&&S(a,b)||V(a,b)}function V(a,c){a.state_===O&&(a.state_=g,a.data_=c,b(u,a))}function v(a,c){a.state_===O&&(a.state_=g,a.data_=c,b(e,a))}function d(a){var b=a.then_;a.then_=void 0;for(a=0;a<b.length;a++)r(b[a])}function u(a){a.state_=z;d(a)}function e(a){a.state_=R;d(a)}function C(a){if("function"!==
typeof a)throw new TypeError("Promise constructor takes a function argument");if(!1===this instanceof C)throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this.then_=[];h(a,this)}var w=c.Promise,y=w&&"resolve"in w&&"reject"in w&&"all"in w&&"race"in w&&function(){var a;new w(function(b){a=b});return"function"===typeof a}();"undefined"!==typeof exports&&exports?(exports.Promise=y?w:C,exports.Polyfill=C):"function"==
typeof define&&define.amd?define(function(){return y?w:C}):y||(c.Promise=C);var O="pending",g="sealed",z="fulfilled",R="rejected",U=function(){},Q="undefined"!==typeof setImmediate?setImmediate:setTimeout,D=[],aa;C.prototype={constructor:C,state_:O,then_:null,data_:void 0,then:function(a,c){var d={owner:this,then:new this.constructor(U),fulfilled:a,rejected:c};this.state_===z||this.state_===R?b(r,d):this.then_.push(d);return d.then},"catch":function(a){return this.then(null,a)}};C.all=function(a){if("[object Array]"!==
Object.prototype.toString.call(a))throw new TypeError("You must pass an array to Promise.all().");return new this(function(b,c){function d(a){B++;return function(c){e[a]=c;--B||b(e)}}for(var e=[],B=0,t=0,g;t<a.length;t++)(g=a[t])&&"function"===typeof g.then?g.then(d(t),c):e[t]=g;B||b(e)})};C.race=function(a){if("[object Array]"!==Object.prototype.toString.call(a))throw new TypeError("You must pass an array to Promise.race().");return new this(function(b,c){for(var d=0,e;d<a.length;d++)(e=a[d])&&"function"===
typeof e.then?e.then(b,c):b(e)})};C.resolve=function(a){return a&&"object"===typeof a&&a.constructor===this?a:new this(function(b){b(a)})};C.reject=function(a){return new this(function(b,c){c(a)})}})("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this);
var KPainter=function(c){var a=this;c=c||{};KPainter.xxx="mouse"==c.gesturer?!1:"touch"==c.gesturer?!0:"ontouchend"in document?!0:!1;var b=jQuery,h=function(a,b,c){return new Promise(function(d){if(a.toBlob)a.toBlob(function(a){d(a)},b,c);else{var e=a.toDataURL(b,c),e=kUtil.convertBase64ToBlob(e.substring(e.indexOf(",")+1),b);d(e)}})},r=function(a,b,c){b=b||new kUtil.Matrix(1,0,0,1,0,0);var d=document.createElement("canvas"),e=!1;0!=b.a*b.d&&0==b.b*b.c?(d.width=a.naturalWidth||a.width,d.height=a.naturalHeight||
a.height):(e=!0,d.width=a.naturalHeight||a.height,d.height=a.naturalWidth||a.width);if(d.width>c||d.height>c)c/=Math.max(d.width,d.height),d.width=Math.min(d.width*c),d.height=Math.min(d.height*c);c=d.getContext("2d");c.setTransform(b.a,b.b,b.c,b.d,b.e*d.width,b.f*d.height);e?c.drawImage(a,0,0,d.height,d.width):c.drawImage(a,0,0,d.width,d.height);return d},S=function(a,b,c){return new Promise(function(d){var e=function(){var e=URL.createObjectURL(a),g=new Image;g.onload=g.onerror=function(){g.onload=
g.onerror=null;var a=r(g,b,c);URL.revokeObjectURL(e);d(a)};g.src=e};window.createImageBitmap?createImageBitmap(a).then(function(a){d(r(a,b,c))})["catch"](function(){e()}):e()})},x=KPainter._doCallbackNoBreak,V=b('<div style="width:800px;height:600px;border:1px solid #ccc;"><div class="kPainterBox"><div class="kPainterImgsDiv"><canvas class="kPainterCanvas" style="display:none;left:0;top:0;"></canvas></div><div class="kPainterCroper" style="width:50px;height:50px;display:none;"><div class="kPainterCells"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div class="kPainterBigMover" data-orient="0,0" style="display:none"></div><div class="kPainterEdges"><div data-orient="-1,0"></div><div data-orient="0,-1"></div><div data-orient="1,0"></div><div data-orient="0,1"></div></div><div class="kPainterCorners"><div data-orient="-1,-1"><i></i></div><div data-orient="1,-1"><i></i></div><div data-orient="1,1"><i></i></div><div data-orient="-1,1"><i></i></div></div><div class="kPainterMover" data-orient="0,0"><div></div><svg width="20" height="20" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 896q0 26-19 45l-256 256q-19 19-45 19t-45-19-19-45v-128h-384v384h128q26 0 45 19t19 45-19 45l-256 256q-19 19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-384h-384v128q0 26-19 45t-45 19-45-19l-256-256q-19-19-19-45t19-45l256-256q19-19 45-19t45 19 19 45v128h384v-384h-128q-26 0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45t-19 45-45 19h-128v384h384v-128q0-26 19-45t45-19 45 19l256 256q19 19 19 45z" fill="#fff"/></svg></div></div><div class="kPainterPerspect" style="display:none;"><canvas class="kPainterPerspectCvs"></canvas><div class="kPainterPerspectCorner" data-index="0">lt</div><div class="kPainterPerspectCorner" data-index="1">rt</div><div class="kPainterPerspectCorner" data-index="2">rb</div><div class="kPainterPerspectCorner" data-index="3">lb</div></div><div class="kPainterGesturePanel"></div></div></div>')[0],
v=b(V).children(),d=v.find("> .kPainterImgsDiv > .kPainterCanvas")[0];a.getHtmlElement=function(){return V};var u=-1,e=[],C=null,w=null,y=!1,O="view";a.getCurIndex=function(){return u};a.getCount=function(){return e.length};a.isEditing=function(){return y};a.getMode=function(){return O};a.getImage=function(a,c){void 0==c&&(c=u);if(!(isNaN(c)||(c=Math.round(c),0>c||c>=e.length))){var d;a?d=e[c]:(d=b(e[c]).clone()[0],d.setAttribute("style",""));return d}};a.onStartLoading=null;a.onFinishLoading=null;
var g=function(){x(a.onStartLoading)},z=function(){x(a.onFinishLoading)},R=new function(){a.defaultFileInput=b('<input type="file" accept="image/bmp,image/gif,image/jpeg,image/png,image/webp" multiple style="display:none">')[0];a.beforeAddImgFromFileChooseWindow=null;a.afterAddImgFromFileChooseWindow=null;b(a.defaultFileInput).change(function(b){var f=this;b=b.originalEvent;var c=function(b){d(b).then(function(b){x(a.afterAddImgFromFileChooseWindow,[!0,b]);f.value=""},function(b){x(a.afterAddImgFromFileChooseWindow,
[!1,b]);f.value=""})};a.beforeAddImgFromFileChooseWindow?x(a.beforeAddImgFromFileChooseWindow,[b,function(a){c(a)}]):c(f.files)});a.showFileChooseWindow=function(){if(y)return!1;a.defaultFileInput.click();return!0};a.beforeAddImgFromDropFile=null;a.afterAddImgFromDropFile=null;v.on("dragover",function(a){a=a.originalEvent;a.stopPropagation();a.preventDefault()});v.on("drop",function(b){b=b.originalEvent;b.stopPropagation();b.preventDefault();var f=function(b){d(b).then(function(b){x(a.afterAddImgFromDropFile,
[!0,b])},function(b){x(a.afterAddImgFromDropFile,[!1,b])})};a.beforeAddImgFromDropFile?x(a.beforeAddImgFromDropFile,[b,function(a){f(a)}]):f(b.dataTransfer.files)});var c=new TaskQueue,d=a.addImage=function(a){return new Promise(function(b,p){if(y)return p(Error("`addImage(imgData)`: The function is only valid in `view` mode."));if(!(a instanceof Blob||a instanceof HTMLCanvasElement||"string"==typeof a||a instanceof String||a instanceof HTMLImageElement)){if(a instanceof Array||a instanceof FileList){for(var f=
[],m=!1,k=0;k<a.length;++k)d(a[k]).then(function(c){f.push(c);m=!0;f.length==a.length&&b(f)},function(c){f.push(c);f.length==a.length&&(m?b(f):(Error("`addImage(imgData)`: No img added in this array. Get more info in `<this error object>.addImgErrArr`.").addImgErrArr=f,p(Error("`addImage(imgData)`: No img added in this array."))))});return}return p(Error("`addImage(imgData)`: Type of `imgData` should be `Blob`, `HTMLCanvasElement`, `HTMLImageElement`, `String(url)`, `Array(a array of source)`, `FileList`."))}g();
c.push(D,null,[a,function(a){a instanceof Error?p(Error("`addImage(imgData)`: "+a)):b(a);c.next();c.isWorking||z()}])})},t=function(a,b){"image/jpeg"!=a.type?b(null):EXIF.getData(a,function(){var a=null;switch(EXIF.getTag(this,"Orientation")){case 6:a=new kUtil.Matrix(0,1,-1,0,1,0);break;case 3:a=new kUtil.Matrix(-1,0,0,-1,1,1);break;case 8:a=new kUtil.Matrix(0,-1,1,0,0,1)}b(a)})},w=function(a,b){var f=a.slice(25,26),c=new FileReader;c.onload=function(){var a=(new Int8Array(c.result))[0];b(4==(a&
4))};c.readAsArrayBuffer(f)},C=function(a,b){var f=a.type;-1!=f.indexOf("webp")?b&&b("image/webp"):-1!=f.indexOf("gif")||-1!=f.indexOf("svg")?b&&b("image/png"):-1!=f.indexOf("png")?w(a,function(a){b&&b(a?"image/png":"image/jpeg")}):b&&b("image/jpeg")},D=function(a,b){M(a,function(a,f){a instanceof Blob?x(function(){I(a,f,b)}):b(a)})},M=this.getBlobAndFormatFromAnyImgData=function(a,b){var f=function(a){C(a,function(f){t(a,function(c){G(a,c,f,function(a){b(a,f)})})})};if(a instanceof Blob)f(a);else if(a instanceof
HTMLCanvasElement)h(a).then(f);else if("string"==typeof a||a instanceof String)if("data:"==a.substring(0,5)){var c="";"image/"==a.substring(5,11)&&(c=a.substring(5,a.indexOf(";",11)));c=kUtil.convertBase64ToBlob(a.substring(a.indexOf("base64,")+7),c);f(c)}else kUtil.convertURLToBlob(a,function(a){a?f(a):b("Network error.")});else if(a instanceof HTMLImageElement)if(a.crossOrigin&&"anonymous"!=a.crossOrigin)b("Cors error.");else{var p=a.src;M(p,function(c,l){if(c instanceof Blob)b(c,l);else{var m=
document.createElement("canvas");m.width=a.naturalWidth;m.height=a.naturalHeight;m.getContext("2d").drawImage(a,0,0);var k="",d=p.lastIndexOf("?"),q;-1!=d?(q=p.lastIndexOf(".",d),-1!=q&&5>=d-q&&(k=p.substring(q+1,d))):(q=p.lastIndexOf("."),-1!=q&&(k=5>=p.length-q?p.substring(q+1):p.substring(q+1,q+5)));k=-1!=k.indexOf("webp")?"image/webp":-1!=k.indexOf("png")||-1!=k.indexOf("gif")||-1!=k.indexOf("svg")?"image/png":"image/jpeg";h(m,k).then(f)}})}else b("Type of `imgData` not support.")};a.addedImageMaxWH=
4096;var G=function(a,b,c,l){b?S(a,b).then(function(a){h(a,c).then(function(a){l&&l(a)})}):l&&l(a)};a.isShowNewImgWhenAdd=!0;var I=function(c,f,m){var l=new Image;l.kPainterOriBlob=l.kPainterBlob=c;l.kPainterSaveFormat=f;var p=URL.createObjectURL(l.kPainterBlob);l.onload=l.onerror=function(){a._noAnyUseButForIosSafariBug0=l.naturalWidth;a._noAnyUseButForIosSafariBug1=l.naturalHeight;l.kPainterWidth=l.naturalWidth;l.kPainterHeight=l.naturalHeight;l.kPainterOriWidth=l.kPainterWidth;l.kPainterOriHeight=
l.kPainterHeight;if(l.kPainterWidth>a.addedImageMaxWH||l.kPainterHeight>a.addedImageMaxWH)h(r(l,null,a.addedImageMaxWH),f).then(function(a){URL.revokeObjectURL(p);l.kPainterOriBlob=l.kPainterBlob=a;p=URL.createObjectURL(l.kPainterBlob);l.src=p});else{l.onload=l.onerror=null;v.children(".kPainterImgsDiv").append(l);(a.isShowNewImgWhenAdd||-1==u)&&K(e.length-1);try{(function(){for(var a=0;a<k.length;++a){var b=k[a].cvs,f=k[a].mwh,f=Math.min(f/l.naturalWidth,f/l.naturalHeight,1);b.width=Math.round(l.naturalWidth*
f);b.height=Math.round(l.naturalHeight*f);b.getContext("2d").drawImage(l,0,0,b.width,b.height)}})()}catch(A){setTimeout(function(){throw A;},0)}m&&m(e.length-1)}};var k=[];try{(function(){for(var a=0;a<n.length;++a){var b=n[a],f=b.kPainterFunWrap,c=document.createElement("canvas");c.className="kPainterThumbnailCanvas";k.push({cvs:c,mwh:b.kPainterMaxWH});var l=null;try{l=f?f(c):c}catch(X){setTimeout(function(){throw X;},0);break}l&&(l.getKPainterIndex=function(){return b.kPainterThumbBoxArr.indexOf(this)},
b.kPainterThumbBoxArr.push(l),b.appendChild(l))}})()}catch(A){setTimeout(function(){throw A;},0)}b(l).hide();e.push(l);l.src=p},T=function(){var b=e[u],f=v;f.paddingBoxRect();var f=f.contentBoxRect(),c=b.kPainterZoom=Math.min(f.width/b.kPainterWidth,f.height/b.kPainterHeight);b.style.width=(Math.round(b.kPainterWidth*c)||1)+"px";b.style.height=(Math.round(b.kPainterHeight*c)||1)+"px";b.style.left=b.style.right=b.style.top=b.style.bottom="-100000px";if(2<=e.length){var l=e[(e.length+u-1)%e.length],
c=Math.min(f.width/l.kPainterWidth,f.height/l.kPainterHeight);l.style.width=(Math.round(l.kPainterWidth*c)||1)+"px";l.style.height=(Math.round(l.kPainterHeight*c)||1)+"px";l.style.right="100000px";l.style.left=l.style.top=l.style.bottom="-100000px"}3<=e.length&&(b=e[(e.length+u+1)%e.length],c=Math.min(f.width/b.kPainterWidth,f.height/b.kPainterHeight),b.style.width=(Math.round(b.kPainterWidth*c)||1)+"px",b.style.height=(Math.round(b.kPainterHeight*c)||1)+"px",b.style.left="100000px",b.style.right=
b.style.top=l.style.bottom="-100000px");x(a.onUpdateImgPosZoom)},N=null,P=null,L;a.updateUIOnResize=function(b){null!=N&&(clearTimeout(N),N=null,P());return b?new Promise(function(b,c){L=y;N=setTimeout(function(){if(-1!=u&&L==y)if(y){var c=a.getFreeTransformCornerPos();U.setImgStyleFit();a.setFreeTransformCornerPos(c)}else T();N=null;b()},500);P=c}):-1!=u?(y?(b=a.getFreeTransformCornerPos(),U.setImgStyleFit(),a.setFreeTransformCornerPos(b)):T(),!0):!1};var K=this.showImg=function(c){var f=e[c];b(f).siblings().hide();
u=c;b(f).show();2<=e.length&&(0<c||a.allowedTouchMoveSwitchImgOverBoundary)&&b(e[(e.length+c-1)%e.length]).show();3<=e.length&&(c<e.length-1||a.allowedTouchMoveSwitchImgOverBoundary)&&b(e[(e.length+c+1)%e.length]).show();T();H()};a.onNumChange=null;var H=function(){var b=void 0,c=void 0;return function(){if(b!=u||c!=e.length)b=u,c=e.length,x(a.onNumChange,[u,e.length])}}();a.changePage=function(a){if(y)return!1;var b;switch(a){case "f":b=0;break;case "p":b=u-1;break;case "n":b=u+1;break;case "l":b=
e.length-1;break;default:if(1>arguments.length||isNaN(a))return!1;b=Math.round(a)}if(0>b||b>=e.length||b==u)return!1;K(b);return!0};a.movePage=function(){if(y)return!1;var a,c;1==arguments.length?c=arguments[0]:2<=arguments.length&&(a=arguments[0],c=arguments[1]);void 0==a&&(a=u);if(isNaN(c))return!1;c=Math.round(c);if(0>c||c>e.length||isNaN(a))return!1;a=Math.round(a);if(0>a||a>=e.length)return!1;if(a==c)return!0;var m=e.splice(a,1)[0];c>a?e.splice(c-1,0,m):e.splice(c,0,m);a==u?u=c>a?c-1:c:a<u&&
c>u?--u:a>u&&c<u&&++u;H();try{for(m=0;m<n.length;++m){var l=n[m],d=l.kPainterThumbBoxArr[a];l.kPainterThumbBoxArr.length==c?b(l).append(d):b(l.kPainterThumbBoxArr[c]).before(d);l.kPainterThumbBoxArr.splice(a,1);c>a?l.kPainterThumbBoxArr.splice(c-1,0,d):l.kPainterThumbBoxArr.splice(c,0,d)}}catch(k){setTimeout(function(){throw k;},0)}return!0};a.del=function(a){if(y)return!1;1>arguments.length&&(a=u);if(isNaN(a))return!1;a=Math.round(a);if(0>a||a>=e.length)return!1;URL.revokeObjectURL(e[a].src);b(e[a]).remove();
e.splice(a,1);try{for(var c=0;c<n.length;++c){var m=n[c];b(m.kPainterThumbBoxArr[a]).remove();m.kPainterThumbBoxArr.splice(a,1)}}catch(l){setTimeout(function(){throw l;},0)}a<u?(--u,H()):a==u?(u==e.length&&--u,0<=u?K(u):H()):H();return!0};a.getWidth=function(a){1>arguments.length&&(a=u);if(isNaN(a))return NaN;a=Math.round(a);return 0>a||a>=e.length?NaN:e[a].kPainterWidth};a.getHeight=function(a){1>arguments.length&&(a=u);if(isNaN(a))return NaN;a=Math.round(a);return 0>a||a>=e.length?NaN:e[a].kPainterHeight};
a.getBlob=function(a){1>arguments.length&&(a=u);if(isNaN(a))return null;a=Math.round(a);return 0>a||a>=e.length?null:e[a].kPainterBlob};a.download=function(a,b){2>arguments.length&&(b=u);if(isNaN(b))return null;b=Math.round(b);if(0>b||b>=e.length)return null;var c=document.createElement("a");c.target="_blank";var f=e[b].kPainterBlob;if(!a){var d="";f.type&&(d=f.type.substring(f.type.indexOf("/")+1));d="jpeg"==d?".jpg":"."+d;a=(new Date).getTime()+d}c.download=a;var k=URL.createObjectURL(f);c.href=
k;f=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});c.dispatchEvent(f);setTimeout(function(){URL.revokeObjectURL(k)},1E4);return a};var n=this.thumbnailBoxArr=[];a.bindThumbnailBox=function(b,c,m){if(y||!(b instanceof HTMLElement))return!1;a.unbindThumbnailBox(b);b.innerHTML="";b.kPainterFunWrap=c;b.kPainterMaxWH=m||256;b.kPainterThumbBoxArr=[];for(m=0;m<e.length;++m){var f=e[m];a._noAnyUseButForIosSafariBug0=f.naturalWidth;a._noAnyUseButForIosSafariBug1=f.naturalHeight;var d=Math.min(b.kPainterMaxWH/
f.naturalWidth,b.kPainterMaxWH/f.naturalHeight,1),k=document.createElement("canvas");k.width=Math.round(f.naturalWidth*d);k.height=Math.round(f.naturalHeight*d);k.getContext("2d").drawImage(f,0,0,k.width,k.height);k.className="kPainterThumbnailCanvas";f=null;try{f=c?c(k):k}catch(A){return setTimeout(function(){throw A;},0),!1}f&&(f.getKPainterIndex=function(){return b.kPainterThumbBoxArr.indexOf(this)},b.kPainterThumbBoxArr.push(f),b.appendChild(f))}n.push(b);return!0};a.unbindThumbnailBox=function(a){if(y)return!1;
if(a){for(var b=0;b<n.length;++b)if(n[b]==a)return a.innerHTML="",a.kPainterFunWrap=void 0,a.kPainterThumbBoxArr=void 0,n.splice(b,1),!0;return!1}for(b=0;b<n.length;++b)a=n[b],a.innerHTML="",a.kPainterFunWrap=void 0,a.kPainterThumbBoxArr=void 0;n.length=0;return!0}};(function(a){a=a.length?a:function(a){var b=a.indexOf(".");return[a.substring(b,b+32),a.substring(0,8)]}(location.host);for(var b=null,c=0;c<a.length;++c){for(var d=1,e=a[c],g=0;g<e.length;++g)d*=e.charCodeAt(g),d+=e.charCodeAt((g+1)%
e.length),d%=11003;if(1!=d&&7480!=d&&5095!=d&&3124!=d&&8633!=d&&3122!=d)b=setTimeout(function(){x=function(){}},1E5*(1+2*Math.random()));else{null!==b&&clearTimeout(b);break}}})(arguments);var U=new function(){var c=Number.NEGATIVE_INFINITY,g;a.leftDoubleClickZoomRate=2;a.rightDoubleClickZoomRate=.5;var h,z,r,Y,M,G,I,T,N,P,L,K,H,n,p,f,m,l,q,k,A,J;a.allowedTouchMoveSwitchImgOverBoundary=!0;var Z=function(){if(-1!=u&&"posZoom"==C){C=w=null;v.find("> .kPainterCroper > .kPainterEdges").children().css("z-index",
1);v.find("> .kPainterCroper > .kPainterCorners").children().css("z-index",1);v.find("> .kPainterCroper > .kPainterMover").css("z-index",1);v.find("> .kPainterCroper > .kPainterBigMover").css("z-index",1);if(!y&&1!=e.length){var b=!1,d,m;1.2>k/A&&(b=!0,d=Math.sqrt(Math.pow(M-h,2)+Math.pow(G-z,2)),m=d/(((new Date).getTime()-c)/1E3));if(l<-(Math.round(f*k)||1)/2||b&&-50>d&&-200>m){if(u+1<e.length||a.allowedTouchMoveSwitchImgOverBoundary){R.showImg((e.length+u+1)%e.length);return}}else if(l>(Math.round(f*
k)||1)/2||b&&50<d&&200<m)if(0<=u-1||a.allowedTouchMoveSwitchImgOverBoundary){R.showImg((e.length+u-1)%e.length);return}}X();W()}},E=function(a){var c=v;y?(n=d,f=n.width,m=n.height):(n=e[u],f=n.kPainterWidth,m=n.kPainterHeight);l=parseFloat(n.style.left)+1E5;q=parseFloat(n.style.top)+1E5;p=b(n).getTransform();if(0==p.a*p.d||0!=p.b*p.c){var J=f;f=m;m=J}k=n.kPainterZoom||1;K=c.paddingBoxRect();H=c.contentBoxRect();A=Math.min(H.width/f,H.height/m);y&&D.isCropRectShowing&&!a&&(a=D.getNeededRect(),A=Math.max(Math.max(a.width,
f*A)/f,Math.max(a.height,m*A)/m))};a.onUpdateImgPosZoom=null;var W=function(){n.style.left=l-1E5+"px";n.style.right=-l-1E5+"px";n.style.top=q-1E5+"px";n.style.bottom=-q-1E5+"px";n.kPainterZoom=k;0!=p.a*p.d&&0==p.b*p.c?(n.style.width=(Math.round(f*k)||1)+"px",n.style.height=(Math.round(m*k)||1)+"px"):(n.style.height=(Math.round(f*k)||1)+"px",n.style.width=(Math.round(m*k)||1)+"px");if(!y&&1!=e.length){var b=Math.max(0,((Math.round(f*k)||1)-K.width)/2);if(2<e.length||l>b){var c=e[(e.length+u-1)%e.length];
c.style.left=l-b-K.width+"px";c.style.right=-l+b+K.width+"px"}if(2<e.length||l<=-b)c=e[(e.length+u+1)%e.length],c.style.left=l+b+K.width+"px",c.style.right=-l-b-K.width+"px"}x(a.onUpdateImgPosZoom)},X=function(a,b){4<k&&(k=4);k<A&&(k=A);if(!a){var c=Math.round(f*k)||1;H.width>c?l=0:(c=(c-H.width)/2,l<-c?l=-c:l>c&&(l=c))}b||(c=Math.round(m*k)||1,H.height>c?q=0:(c=(c-H.height)/2,q<-c?q=-c:q>c&&(q=c)))};a.getZoom=function(){if(0!=e.length)return E(),k};a.setZoom=function(a,b){if(0==e.length)return null;
a=parseFloat(a);if(a!==a)return null;E();k=b?k*a:a;X();W();return k};this.setImgStyleFit=function(){E(!0);k=A;X();W();a.setCropRectArea()};v.on("touchstart touchcancel touchend mousedown",function(b){b.preventDefault();if(-1!=u){var f=b.originalEvent;b=f.targetTouches;var d;if(!b){if(!w)w="mouse";else if("mouse"!=w)return;b=[{pageX:f.clientX,pageY:f.clientY}];d=f.buttons}else if(b.length)if(!w)w="touch";else if("touch"!=w)return;if(1==b.length){M=h=b[0].pageX;G=z=b[0].pageY;E();f=c;c=(new Date).getTime();
var m=g;g=d||(.01>Math.abs(k-A)/A?1:2);if(1E3>c-f&&g==m&&(1==g||2==g)&&8>Math.abs(b[0].pageX-r)&&8>Math.abs(b[0].pageY-Y)){c=Number.NEGATIVE_INFINITY;d=M;var f=G,e=k,m=1==g?a.leftDoubleClickZoomRate:a.rightDoubleClickZoomRate;k*=m;4<k&&(k=4,m=4/e);k<A&&(k=A,m=A/e);e=q+K.pageY0+K.height/2;l-=(m-1)*(d-(l+K.pageX0+K.width/2));q-=(m-1)*(f-e);X()}null==C&&(C="posZoom",v.find("> .kPainterCroper > .kPainterEdges").children().css("z-index","unset"),v.find("> .kPainterCroper > .kPainterCorners").children().css("z-index",
"unset"),v.find("> .kPainterCroper > .kPainterMover").css("z-index","unset"),v.find("> .kPainterCroper > .kPainterBigMover").css("z-index","unset"),J=b[0].identifier)}else 2==b.length?(M=h=b[0].pageX,G=z=b[0].pageY,null==C&&(C="posZoom"),"posZoom"==C&&(E(),v.find("> .kPainterCroper > .kPainterEdges").children().css("z-index","unset"),v.find("> .kPainterCroper > .kPainterCorners").children().css("z-index","unset"),v.find("> .kPainterCroper > .kPainterMover").css("z-index","unset"),v.find("> .kPainterCroper > .kPainterBigMover").css("z-index",
"unset"),N=b[1].pageX,P=b[1].pageY,I=(M+N)/2,T=(G+P)/2,L=Math.sqrt(Math.pow(M-N,2)+Math.pow(G-P,2)))):0==b.length&&(r=M,Y=G,Z())}});v.on("mouseup",function(a){"mouse"==w&&(a=a.originalEvent,r=a.clientX,Y=a.clientY,Z())});v.on("mouseleave",function(a){"mouse"==w&&a.originalEvent.buttons&&(r=M,Y=G,Z())});v.on("contextmenu",function(a){a.preventDefault()});v.on("touchmove mousemove",function(a){a.preventDefault();var b=a.originalEvent.targetTouches;if(!b){if("mouse"!=w)return;b=[{pageX:a.originalEvent.clientX,
pageY:a.originalEvent.clientY}]}else if("touch"!=w)return;if(1==b.length){if("posZoom"==C&&J==b[0].identifier){a=M;var c=G;M=b[0].pageX;G=b[0].pageY;l+=M-a;q+=G-c;X(!y);W()}}else if(2==b.length&&"posZoom"==C){a=I;var c=T,f=L,d=k;M=b[0].pageX;G=b[0].pageY;N=b[1].pageX;P=b[1].pageY;I=(M+N)/2;T=(G+P)/2;L=Math.sqrt(Math.pow(M-N,2)+Math.pow(G-P,2));b=L/f;k*=b;4<k&&(k=4,b=4/d);k<A&&(k=A,b=A/d);d=q+K.pageY0+K.height/2;l-=(b-1)*(a-(l+K.pageX0+K.width/2));q-=(b-1)*(c-d);X();W()}})},Q=new function(){var c=
this,B,t=[];a.stepImgsGCThreshold=10;var r=[],x=[];a.addProtectedStep=function(a){if(!y)return!1;a=parseInt(a);if(a!==a)return!1;if(-1!=x.indexOf(a))return!0;x.push(a);x.sort(function(a,b){return a-b});return!0};a.removeProtectedStep=function(a){if(!y)return!1;a=parseInt(a);if(a!==a)return!1;a=x.indexOf(a);if(-1==a)return!1;x.splice(a,1);return!0};a.getProtectedSteps=function(){return y?x.concat():null};var Y=c.pushStack=function(b){t.length=B+1;for(var c=r.length-1;0<c;--c)if(r[c].beginStep>B)--r.length;
else break;var d;if(b.srcBlob){d={crop:{left:0,top:0,width:1,height:1},transform:new kUtil.Matrix(1,0,0,1,0,0),srcBlob:b.srcBlob,saveFormat:b.saveFormat};for(c=0;r.length>=a.stepImgsGCThreshold;)if(x.filter(function(a){return r[c].beginStep<=a&&a<r[c].endStep}).length){if(!(++c<r.length))break}else{b=r[c].endStep;for(var f=r[c].beginStep;f<b;++f)t[f]=null;r.splice(c,1)}t.push(d);++B;r.push({blob:d.srcBlob,beginStep:B,endStep:B+1})}else{d=t[B];var m=d.crop,l=b.transform,q=b.crop,f={};b=l?l:d.transform;
f.left=m.left;f.top=m.top;f.width=m.width;f.height=m.height;0!=b.a*b.d&&0==b.b*b.c?(l&&(b=new kUtil.Matrix(Math.sign(l.a),0,0,Math.sign(l.d),0,0)),q&&(f.left=1==b.a?f.left+q.left*m.width:f.left+(1-q.left-q.width)*m.width,f.top=1==b.d?f.top+q.top*m.height:f.top+(1-q.top-q.height)*m.height,f.width*=q.width,f.height*=q.height)):(l&&(b=new kUtil.Matrix(0,Math.sign(l.b),Math.sign(l.c),0,0,0)),q&&(f.left=1==b.b?f.left+q.top*m.width:f.left+(1-q.top-q.height)*m.width,f.top=1==b.c?f.top+q.left*m.height:f.top+
(1-q.left-q.width)*m.height,f.width*=q.height,f.height*=q.width));m=e[u];m=Math.pow(10,Math.ceil(Math.max(m.kPainterWidth,m.kPainterHeight)).toString().length+2);f.left=Math.round(f.left*m)/m;f.top=Math.round(f.top*m)/m;f.width=Math.round(f.width*m)/m;f.height=Math.round(f.height*m)/m;d={crop:f,transform:b,srcBlob:d.srcBlob,saveFormat:d.saveFormat};t.push(d);++B;d.srcBlob&&(r[r.length-1].endStep=B+1)}};a.undo=function(){return new Promise(function(a,b){if(!y)return b(Error("`undo()`: The function is invalid in current mode."));
if(0<B){for(var c=B-1;null==t[c];)--c;M(B,c,function(){return a()})}})};a.redo=function(){return new Promise(function(a,b){if(!y)return b(Error("`undo()`: The function is invalid in current mode."));if(B<t.length-1){for(var c=B+1;null==t[c];)++c;M(B,c,function(){return a()})}})};a.getStepCount=function(){return y?t.length:NaN};a.getCurStep=function(){return y?B:NaN};a.setCurStep=function(a){return new Promise(function(b,c){if(1>arguments.length||isNaN(a))return c(Error("`setCurStep(index)`: The parameter `index` is invalid."));
a=Math.round(a);if(0>a||a>=t.length||null==t[a])return c(Error("`setCurStep(index)`: The parameter `index` is invalid."));M(B,a,function(){return b()})})};c.needAlwaysTrueTransform=!1;var M=function(a,e,g){B=e;e=t[a].crop;var f=t[B].crop;e.left==f.left&&e.top==f.top&&e.width==f.width&&e.bottom==f.bottom&&t[a].srcBlob==t[B].srcBlob?(b(d).setTransform(t[B].transform.dot(t[a].transform.inversion()).dot(b(d).getTransform())),U.setImgStyleFit(),g&&g()):T(c.needAlwaysTrueTransform,!1,g)},G=function(c){b(d).siblings().hide();
T(!1,!1,function(){a.isAutoShowCropUI&&D.showCropRect();c&&c()})},I;I=Math.min(screen.width,screen.height)*(window.devicePixelRatio||1);var T=c.updateCvsAsync=function(a,c,g){b(d).hide();var f=t[B],m=f.srcBlob||e[u].kPainterOriBlob,l=function(){var b=URL.createObjectURL(m),d=new Image;d.onload=d.onerror=function(){d.onload=d.onerror=null;N(d,f,a,c);URL.revokeObjectURL(b);g&&g()};d.src=b};window.createImageBitmap?createImageBitmap(m).then(function(b){N(b,f,a,c);g&&g()})["catch"](function(){l()}):l()},
N=function(c,e,g,f){a._noAnyUseButForIosSafariBug0=c.naturalWidth;a._noAnyUseButForIosSafariBug1=c.naturalHeight;var m=c.naturalWidth||c.width,l=c.naturalHeight||c.height,q=e.crop;e=e.transform;var k=d.getContext("2d"),A=d.fullQualityWidth=Math.round(m*q.width)||1,J=d.fullQualityHeight=Math.round(l*q.height)||1,h=!1;0!=e.a*e.d&&0==e.b*e.c?(d.fullQualityWidth=A,d.fullQualityHeight=J):(d.fullQualityWidth=J,d.fullQualityHeight=A,g&&(h=!0));d.hasCompressed=!1;if(g){var E,p;h?(E=J,p=A):(E=A,p=J);d.width=
E;d.height=p;k.setTransform(e.a,e.b,e.c,e.d,E/2*(1-e.a-e.c),p/2*(1-e.b-e.d))}else A>I||J>I?(E=I/Math.max(A,J),d.width=Math.round(A*E)||1,d.height=Math.round(J*E)||1,d.hasCompressed=!0):(d.width=A,d.height=J);E=Math.round(m*q.left);q=Math.round(l*q.top);E==m&&--E;q==l&&--q;h?(m=d.height,l=d.width):(m=d.width,l=d.height);if(2>=A/m)k.drawImage(c,E,q,A,J,0,0,m,l);else{h=document.createElement("canvas");h.width=Math.round(A/2);h.height=Math.round(J/2);p=h.getContext("2d");var t=Math.round(A/2),n=Math.round(J/
2);for(p.drawImage(c,E,q,A,J,0,0,t,n);;){c=t;A=n;t=Math.round(c/2);n=Math.round(A/2);if(t<=m||n<=l)break;p.drawImage(h,0,0,c,A,0,0,t,n)}k.drawImage(h,0,0,c,A,0,0,m,l)}g?b(d).setTransform(new kUtil.Matrix(1,0,0,1,0,0)):b(d).setTransform(e);f||(U.setImgStyleFit(),b(d).show())};a.enterEdit=function(){return new Promise(function(a,b){if(y)return b(Error("`enterEdit()`: The function is invalid in current mode."));if(-1==u)return b(Error("`enterEdit()`: There is no image in the instance."));O="";g();y=
!0;var c=e[u].kPainterProcess||{crop:{left:0,top:0,width:1,height:1},transform:new kUtil.Matrix(1,0,0,1,0,0),srcBlob:null,saveFormat:null};t.push(c);B=0;G(function(){z();C=w=null;O="basicEdit";return a()})})};var P=a.cancelEdit=function(){if(!y)return!1;y=!1;t.length=0;r.length=0;R.showImg(u);b(d).hide();D.hideCropRect();aa.hideFreeTransformBorderDirectly();C=w=null;O="view";return!0},L=function(a,c){var g=t[B].crop,f=t[B].transform,m=t[0].crop,l=t[0].transform,q=e[u];if(t[B].srcBlob||l.a!=f.a||l.b!=
f.b||l.c!=f.c||l.d!=f.d||Math.round(q.kPainterOriWidth*g.left)!=Math.round(q.kPainterOriWidth*m.left)||Math.round(q.kPainterOriHeight*g.top)!=Math.round(q.kPainterOriHeight*m.top)||Math.round(q.kPainterOriWidth*(g.left+g.width))!=Math.round(q.kPainterOriWidth*(m.left+m.width))||Math.round(q.kPainterOriHeight*(g.top+g.height))!=Math.round(q.kPainterOriHeight*(m.top+m.height))){URL.revokeObjectURL(q.src);var k=new Image,g=function(){k.onload=k.onerror=function(){k.onload=k.onerror=null;c?(b(e[u]).remove(),
e.splice(u,1,k)):e.splice(++u,0,k);v.children(".kPainterImgsDiv").append(k);a&&a()};h(d,t[B].saveFormat||q.kPainterSaveFormat).then(function(a){k.kPainterBlob=a;k.kPainterWidth=d.width;k.kPainterHeight=d.height;t[B].srcBlob?(k.kPainterOriBlob=a,k.kPainterOriWidth=d.width,k.kPainterOriHeight=d.height,k.kPainterSaveFormat=t[B].saveFormat):(k.kPainterOriBlob=q.kPainterOriBlob,k.kPainterOriWidth=q.kPainterOriWidth,k.kPainterOriHeight=q.kPainterOriHeight,k.kPainterProcess=t[B],k.kPainterSaveFormat=q.kPainterSaveFormat);
a=URL.createObjectURL(a);k.src=a})};d.hasCompressed||1!=f.a||0!=f.b||0!=f.c||1!=f.d||0!=f.e||0!=f.f?(b(d).hide(),T(!0,!0,g)):g()}else a()},K=!1;a.saveEdit=function(c){return new Promise(function(d,h){if(!y||K)return h(Error("`saveEdit(isCover)`: The function is invalid in current mode."));O="";K=!0;g();setTimeout(function(){L(function(){P();z();K=!1;C=w=null;try{(function(){for(var f=0;f<R.thumbnailBoxArr.length;++f){var d=R.thumbnailBoxArr[f],l=e[u];a._noAnyUseButForIosSafariBug0=l.naturalWidth;
a._noAnyUseButForIosSafariBug1=l.naturalHeight;var g=Math.min(d.kPainterMaxWH/l.naturalWidth,d.kPainterMaxWH/l.naturalHeight,1),k;c?(k=b(d.kPainterThumbBoxArr[u]),k=k.hasClass("kPainterThumbnailCanvas")?k[0]:k.find(".kPainterThumbnailCanvas")[0]):(k=document.createElement("canvas"),k.className="kPainterThumbnailCanvas");k.width=Math.round(l.naturalWidth*g);k.height=Math.round(l.naturalHeight*g);k.getContext("2d").drawImage(l,0,0,k.width,k.height);if(!c){l=d.kPainterFunWrap;g=null;try{g=l?l(k):k}catch(A){return setTimeout(function(){throw A;
},0),!1}g&&(g.getKPainterIndex=function(){return d.kPainterThumbBoxArr.indexOf(this)},d.kPainterThumbBoxArr.splice(u,0,g),b(d.kPainterThumbBoxArr[u-1]).after(g))}}})()}catch(f){setTimeout(function(){throw f;},0)}O="view";return d()},c)},100)})};a.rotateRight=function(){if(!y)return!1;var a=b(d).getTransform(),a=kUtil.Matrix.dot(new kUtil.Matrix(0,1,-1,0,0,0),a);b(d).setTransform(a);Y({transform:a});a=d.fullQualityWidth;d.fullQualityWidth=d.fullQualityHeight;d.fullQualityHeight=a;U.setImgStyleFit();
return!0};a.rotateLeft=function(){if(!y)return!1;var a=b(d).getTransform(),a=kUtil.Matrix.dot(new kUtil.Matrix(0,-1,1,0,0,0),a);b(d).setTransform(a);Y({transform:a});a=d.fullQualityWidth;d.fullQualityWidth=d.fullQualityHeight;d.fullQualityHeight=a;U.setImgStyleFit();return!0};a.mirror=function(){if(!y)return!1;var a=b(d).getTransform(),a=kUtil.Matrix.dot(new kUtil.Matrix(-1,0,0,1,0,0),a);b(d).setTransform(a);Y({transform:a});U.setImgStyleFit();return!0};a.flip=function(){if(!y)return!1;var a=b(d).getTransform(),
a=kUtil.Matrix.dot(new kUtil.Matrix(1,0,0,-1,0,0),a);b(d).setTransform(a);Y({transform:a});U.setImgStyleFit();return!0};a.resize=function(a,b){return new Promise(function(e,f){if(!y)return f(Error("`resize`: The function is invaild in this mode."));a=parseInt(a);b=parseInt(b);if(a!==a||1>a)return f(Error("`resize`: The parameter `newWidth` is invaild."));if(b!==b||1>b)return f(Error("`resize`: The parameter `newHeight` is invaild."));g();c.updateCvsAsync(!0,!0,function(){c.needAlwaysTrueTransform=
!0;for(var f=a,l=b;2*f<d.width;)f*=2;for(;2*l<d.height;)l*=2;for(var g=d,k;;){k=document.createElement("canvas");k.width=f;k.height=l;k.getContext("2d").drawImage(g,0,0,f,l);var A=!1;a!=f&&(f/=2,A=!0);b!=l&&(l/=2,A=!0);if(!A)break}h(k).then(function(a){c.pushStack({srcBlob:a,saveFormat:"image/jpeg"});c.updateCvs(!1,!1,function(){c.needAlwaysTrueTransform=!1;z();return e()})})})})};a.getEditWidth=function(){return y?d.fullQualityWidth:NaN};a.getEditHeight=function(){return y?d.fullQualityHeight:NaN}},
D=new function(){var c=this;a.isAutoShowCropUI=!0;var e=v.children(".kPainterCroper");c.isCropRectShowing=!1;a.showCropRect=c.showCropRect=function(){y&&(c.isCropRectShowing=!0,X(),e.show())};a.hideCropRect=c.hideCropRect=function(){c.isCropRectShowing=!1;e.hide()};e.css({"border-left-width":"100000px","border-top-width":"100000px","border-right-width":"100000px","border-bottom-width":"100000px",left:"-100000px",top:"-100000px",right:"-100000px",bottom:"-100000px"});a.setCropRectStyle=function(a){switch(parseInt(a)){case 0:return e.find(">.kPainterBigMover").hide(),
e.find(">.kPainterMover").show(),!0;case 1:return e.find(">.kPainterMover").hide(),e.find(">.kPainterBigMover").show(),!0;default:return!1}};var g=void 0;a.setCropRectWidthHeightRate=function(a){g=a;c.isCropRectShowing&&h()};var h=function(){if(g){var a=m/l;a>g?(a=m,m=l*g,p+=(a-m)/2,W()):a<g&&(a=l,l=m/g,f+=(a-l)/2,W())}},u,r,z,G,I,D,N,P,L,K,H,n,p,f,m,l,q,k,A,J;a.cropRectMinW=50;a.cropRectMinH=50;var Z=function(){"crop"==C&&(C=w=null,h())},E=function(){D=v.contentBoxRect();var a=b(d).getTransform(),
c=parseFloat(d.style.left)+1E5,g=parseFloat(d.style.top)+1E5;0!=a.a*a.d&&0==a.b*a.c?(H=parseFloat(d.style.width),n=parseFloat(d.style.height)):(H=parseFloat(d.style.height),n=parseFloat(d.style.width));var a=H/2,h=n/2;N=c-a;P=g-h;L=c+a;K=g+h;m=parseFloat(e[0].style.width);l=parseFloat(e[0].style.height);p=parseFloat(e[0].style.left)-m/2+1E5;f=parseFloat(e[0].style.top)-l/2+1E5;q=Math.max(-D.width/2,N);k=Math.max(-D.height/2,P);A=Math.min(D.width/2,L);J=Math.min(D.height/2,K)};v.find("> .kPainterCroper > .kPainterEdges > div, > .kPainterCroper > .kPainterCorners > div, > .kPainterCroper > .kPainterMover, > .kPainterCroper > .kPainterBigMover").on("touchstart touchcancel touchend mousedown",
function(a){a.preventDefault();var c=a.originalEvent.targetTouches;if(!c){if(!w)w="mouse";else if("mouse"!=w)return;c=[{pageX:a.originalEvent.clientX,pageY:a.originalEvent.clientY}]}else if(c.length)if(!w)w="touch";else if("touch"!=w)return;1==c.length?null==C&&(C="crop",z=c[0].identifier,u=c[0].pageX,r=c[0].pageY,a=b(this).attr("data-orient").split(","),G=a[0],I=a[1],E()):0==c.length&&Z()});v.on("mouseup",function(){"mouse"==w&&Z()});v.on("mouseleave",function(a){"mouse"==w&&a.originalEvent.buttons&&
Z()});a.onCropRectChange=null;var W=function(){e[0].style.left=p+m/2-1E5+"px";e[0].style.right=-p-m/2-1E5+"px";e[0].style.top=f+l/2-1E5+"px";e[0].style.bottom=-f-l/2-1E5+"px";e[0].style.width=m+"px";e[0].style.height=l+"px";x(a.onCropRectChange)};v.on("touchmove mousemove",function(b){b.preventDefault();var c=b.originalEvent.targetTouches;if(!c){if("mouse"!=w)return;c=[{pageX:b.originalEvent.clientX,pageY:b.originalEvent.clientY}]}else if("touch"!=w)return;if(1==c.length&&"crop"==C&&z==c[0].identifier){var d=
u;b=r;u=c[0].pageX;r=c[0].pageY;c=u-d;b=r-b;if(0==G&&0==I)p+c<q?c=q-p:p+m+c>A&&(c=A-m-p),f+b<k?b=k-f:f+l+b>J&&(b=J-l-f),p+=c,f+=b;else if(g){var e,h,E,d=function(){m+e<a.cropRectMinW&&(e=a.cropRectMinW-m);l+e<a.cropRectMinW&&(e=a.cropRectMinW-l);-1==G?p-e<q&&(e=p-q):1==G?p+m+e>A&&(e=A-m-p):(p-e/2<q&&(e=2*(p-q)),p+m+e/2>A&&(e=2*(A-m-p)));-1==I?f-e<k&&(e=f-k):1==I?f+l+e>J&&(e=J-l-f):(f-e/2<k&&(e=2*(f-k)),f+l+e/2>J&&(e=2*(J-l-f)));E=2*e/(g+1);h=E*g};-1==G&&-1==I?(e=(-c+-b)/2,d(),p-=h,f-=E,m+=h,l+=E):
1==G&&-1==I?(e=(c+-b)/2,d(),f-=E,m+=h,l+=E):1==G&&1==I?(e=(c+b)/2,d(),m+=h,l+=E):-1==G&&1==I?(e=(-c+b)/2,d(),p-=E,m+=h,l+=E):-1==I?(e=-b,d(),p-=h/2,f-=E,m+=h,l+=E):1==G?(e=c,d(),f-=e/2,m+=h,l+=E):1==I?(e=b,d(),p-=h/2,m+=h,l+=E):-1==G&&(e=-c,d(),p-=h,f-=E/2,m+=h,l+=E)}else-1==G?(m-c<a.cropRectMinW&&(c=m-a.cropRectMinW),p+c<q&&(c=q-p),m-=c,p+=c):1==G&&(m+c<a.cropRectMinW&&(c=-m+a.cropRectMinW),p+m+c>A&&(c=A-m-p),m+=c),-1==I?(l-b<a.cropRectMinH&&(b=l-a.cropRectMinH),f+b<k&&(b=k-f),l-=b,f+=b):1==I&&(l+
b<a.cropRectMinH&&(b=-l+a.cropRectMinH),f+l+b>J&&(b=J-l-f),l+=b);W()}});var X=a.setCropRectArea=function(a,b,d,e){if(!c.isCropRectShowing)return!1;-.5<=a||(a=-.5);-.5<=b||(b=-.5);.5>=d||(d=.5);.5>=e||(e=.5);a>d&&(a=d=(a+d)/2);b>e&&(b=e=(b+e)/2);E();p=N+(a+.5)*H;p<q&&(p=q);f=P+(b+.5)*n;f<k&&(f=k);a=N+(d+.5)*H;a>A&&(a=A);m=a-p;e=P+(e+.5)*n;e>J&&(e=J);l=e-f;g&&h();W();return!0},ca=a.getCropRectArea=function(a){if(!c.isCropRectShowing)return null;var e=b(d).getTransform();(0!=e.a*e.d&&0==e.b*e.c?parseFloat(d.style.width):
parseFloat(d.style.height))!=H&&E();var e=(p-N)/H-.5,k=(f-P)/n-.5,g=e+m/H,q=k+l/n;a&&(e=Math.round(e*d.fullQualityWidth*2)/2,k=Math.round(k*d.fullQualityHeight*2)/2,g=Math.round(g*d.fullQualityWidth*2)/2,q=Math.round(q*d.fullQualityHeight*2)/2);return[e,k,g,q]};c.getNeededRect=function(){E();var a={};a.width=2*Math.max(-p,p+m);a.height=2*Math.max(-f,f+l);return a};a.crop=function(a){return new Promise(function(b,c){if(!y)return c(Error("crop([ltrb])`: The function is invalid in this mode."));E();
a=a||ca();if(!a)return c(Error("crop([ltrb])`: No thing can be cropped."));var f=a[0],e=a[1],l=a[2],m=a[3];if(.5>(f+.5)*d.fullQualityWidth&&.5>=(.5-l)*d.fullQualityWidth&&.5>(e+.5)*d.fullQualityHeight&&.5>=(.5-m)*d.fullQualityHeight)return b([f,e,l,m]);Q.pushStack({crop:{left:f+.5,top:e+.5,width:l-f,height:m-e}});Q.updateCvsAsync(Q.needAlwaysTrueTransform,!1,function(){return b([f,e,l,m])})})}},aa=new function(){var c=this;(function(){var e=Math.PI/180,t=Math.PI/6,u=Math.PI/18,r=function(a){var c=
d.width,f=d.height,e;c>f?c>a&&(e=a/c,c=a,f=Math.round(f*e)||1):f>a&&(e=a/f,f=a,c=Math.round(c*e)||1);a=b(d).getTransform();var k;0!=a.a*a.d&&0==a.b*a.c?(e=c,k=f):(e=f,k=c);var g=document.createElement("canvas");g.width=e;g.height=k;g=g.getContext("2d");g.setTransform(a.a,a.b,a.c,a.d,e/2*(1-a.a-a.c),k/2*(1-a.b-a.d));g.drawImage(d,0,0,c,f);return g.getImageData(0,0,e,k)},F=function(b,c,d){if("string"==typeof b||b instanceof String||b instanceof Blob)R.getBlobAndFormatFromAnyImgData(b,function(a){a?
S(a).then(function(a){F(a,c,d)}):d(null)});else if(b instanceof Image)try{a._noUseButTestSrc=b.src}catch(E){setTimeout(function(a){throw a;},0);d(null);return}else if(b instanceof ImageData){if(b.width<=c&&b.height<=c){setTimeout(function(){d(b)},0);return}var f=b;b=document.createElement("canvas");b.width=f.width;b.height=f.height;b.getContext("2d").putImageData(f,b.width,b.height)}var e=document.createElement("canvas"),f=b.naturalWidth||b.videoWidth||b.width,l=b.naturalHeight||b.videoHeight||b.height,
m=1;f>l?f>c&&(m=c/f,f=c,l=Math.round(l*m)||1):l>c&&(m=c/l,l=c,f=Math.round(f*m)||1);e.width=f;e.height=l;var g=e.getContext("2d");g.drawImage(b,0,0,e.width,e.height);setTimeout(function(){d(g.getImageData(0,0,e.width,e.height))},0)};a.documentDetect=function(a){return new Promise(function(b,c){if(!a){if("freeTransform"!=O)return c(Error("`documentDetect`: The function is only valid in `freeTransform` mode."));g()}var f=KPainter._cv;F(a||r(256),256,function(c){var d=new f.matFromArray(c,f.CV_8UC4);
c=d.cols;var l=d.rows,m=Math.min(d.cols,d.rows);f.cvtColor(d,d,f.ColorConversionCodes.COLOR_RGBA2GRAY.value,0);var k=new f.Mat;f.GaussianBlur(d,k,[5,5],0,0,f.BORDER_DEFAULT);f.delMat(d);d=new f.Mat;f.Canny(k,d,8,.5*m,3,!1);f.delMat(k);var g=new f.Mat;f.HoughLinesP(d,g,1,e,8,8,3);f.delMat(d);for(var h=g.data32s(),q=[],d=c/2,p=l/2,k=0;k<h.length;k+=2)q.push(h[k]-d),q.push(h[k+1]-p);f.delMat(g);for(var n=[],k=0;k<q.length;k+=4){var g=q[k+0],r=q[k+1],B=q[k+2],v=q[k+3],w=r-v,y=B-g,h=g*v-B*r;if(0!=h){var x=
0>h?-1:1,C=Math.sqrt(w*w+y*y),w=w/C*x,y=y/C*x,h=h/C*x,x=Math.atan(w/y),C=Math.abs(x);C>t&&C<Math.PI/2-t||(0>y?0==w?(y=-1,x=0):x=-x:0<y?0>w?x=-Math.PI-x:0<w?x=Math.PI-x:(y=1,x=Math.PI):0<w?(w=1,x=Math.PI/2):(w=-1,x=-Math.PI/2),g=Math.sqrt((B-g)*(B-g)+(v-r)*(v-r)),n.push([w,y,h,x,g]))}}k=[];q=[];M(n,k,2,u,.7*m);M(k,q,2,u,.7*m);m=[null,null,null,null];for(k=0;k<q.length;++k)n=q[k],x=n[3],r=x<3*-Math.PI/4?0:x<-Math.PI/4?1:x<Math.PI/4?2:x<3*Math.PI/4?3:0,m[r]?(g=m[r],x=g[2],w=g[4],h=n[2],g=n[4],h*g>x*
w&&(m[r]=n)):m[r]=n;for(k=0;k<m.length;++k)n=m[k],null==n&&(n=[],m[k]=n,0==k?(n[2]=p,n[3]=Math.PI):1==k?(n[2]=d,n[3]=-Math.PI/2):2==k?(n[2]=p,n[3]=0):3==k&&(n[2]=d,n[3]=Math.PI/2)),n[0]=Math.sin(n[3]),n[1]=-Math.cos(n[3]);d=[];for(k=0;k<m.length;++k)q=m[k],g=m[(k-1+m.length)%m.length],p=q[0],h=q[1],q=q[2],n=g[0],r=g[1],x=g[2],g=(h*x-r*q)/(r*p-h*n),r=(p*x-n*q)/(n*h-p*r),d.push([g/c,r/l]);a||(T(d),z());b(d)})})};var M=function(a,b,c,d,e){for(var f=0;f<a.length;++f){for(var l=a[f],k=!1,m=0;m<b.length;++m){var g=
b[m],h=g[3],q=l[3],n=h-q;n>Math.PI?q+=2*Math.PI:n<-Math.PI&&(q-=2*Math.PI);n=Math.abs(g[2]-l[2]);if(Math.abs(h-q)<d&&n<c){var k=!0,n=g[4],p=l[4],m=n+p;g[2]=(g[2]*n+l[2]*p)/m;h=(h*n+q*p)/m;h>Math.PI?h-=2*Math.PI:h<=-Math.PI&&(h+=2*Math.PI);g[3]=h;g[4]=Math.min(m,e);break}}k||b.push([null,null,l[2],l[3],l[4]])}},G=v.children(".kPainterPerspect");c.hideFreeTransformBorderDirectly=function(){G.hide()};var I=v.find("> .kPainterPerspect > .kPainterPerspectCvs")[0];a.onFreeTransformCornerPosChange=null;
var T=a.setFreeTransformCornerPos=function(a){if("freeTransform"==O){var c=d.kPainterZoom,f=b(d).getTransform(),e=d.width*c,c=d.height*c;if(0==f.a*f.d||0!=f.b*f.c)f=e,e=c,c=f;for(var k=v.borderBoxRect(),f=k.width/2-5,k=k.height/2-5,g=0;g<L.length;++g){var h=L[g],n=b(h).attr("data-index"),p=a[n],n=e*p[0],p=c*p[1];n<-f?n=-f:n>f&&(n=f);p<-k?p=-k:p>k&&(p=k);h.style.left=n+"px";h.style.right=-n+"px";h.style.top=p+"px";h.style.bottom=-p+"px"}P();G.show()}},N=a.getFreeTransformCornerPos=function(){var a=
d.kPainterZoom,c=b(d).getTransform(),e=d.width*a,a=d.height*a;if(0==c.a*c.d||0!=c.b*c.c)c=e,e=a,a=c;for(var c=[],g=0;g<L.length;++g){var k=L[g];c.push([parseFloat(k.style.left)/e,parseFloat(k.style.top)/a])}return c},P=function(){var b=v.borderBoxRect();I.width=Math.round(b.width);I.height=Math.round(b.height);for(var c=[],d=0;d<L.length;++d)c.push([Math.round(parseFloat(L[d].style.left)+b.width/2),Math.round(parseFloat(L[d].style.top)+b.height/2)]);for(var b=I.getContext("2d"),e=Number.POSITIVE_INFINITY,
k,d=0;4>d;++d){var g=c[d][0]*c[d][0]+c[d][1]*c[d][1];g<e&&(e=g,k=d)}for(var h=[],d=0;4>d;++d)h.push([c[(k+d)%4][0],c[(k+d)%4][1]]);b.fillStyle="rgba(0,0,0,0.3)";b.beginPath();b.moveTo(0,0);b.lineTo(h[0][0],h[0][1]);k=function(a,b,c,d,f,e,h,k){return[Math.sign((d-b)*f+(a-c)*e+c*b-a*d),Math.sign((d-b)*h+(a-c)*k+c*b-a*d)]};c=[];for(d=0;4>d;++d)c.push(k(h[d][0],h[d][1],h[(d+1)%4][0],h[(d+1)%4][1],h[(d+2)%4][0],h[(d+2)%4][1],h[(d+3)%4][0],h[(d+3)%4][1]));d=function(a,b,c,d,f,e,h,k){var g=d-b,l=a-c;a=c*
b-a*d;b=k-e;c=f-h;f=h*e-f*k;e=l*b-c*g;return[(a*c-f*l)/e,(f*g-a*b)/e]};k=void 0;e=function(){var a,b,c=h[1][0]-h[0][0];c&&(a=(h[1][1]-h[0][1])/c);var d=h[3][0]-h[0][0];d&&(b=(h[3][1]-h[0][1])/d);return 0<c?0<d?a<=b:!0:0==c?0<d?!1:!0:0<=d?!1:a<=b}();0>c[0][0]*c[0][1]?0>c[2][0]*c[2][1]&&(k=d(h[0][0],h[0][1],h[1][0],h[1][1],h[2][0],h[2][1],h[3][0],h[3][1]),e?(b.lineTo(k[0],k[1]),b.lineTo(h[2][0],h[2][1]),b.lineTo(h[1][0],h[1][1]),b.lineTo(k[0],k[1]),b.lineTo(h[3][0],h[3][1])):(b.lineTo(h[3][0],h[3][1]),
b.lineTo(k[0],k[1]),b.lineTo(h[1][0],h[1][1]),b.lineTo(h[2][0],h[2][1]),b.lineTo(k[0],k[1]))):0>c[1][0]*c[1][1]&&0>c[3][0]*c[3][1]&&(k=d(h[1][0],h[1][1],h[2][0],h[2][1],h[3][0],h[3][1],h[0][0],h[0][1]),e?(b.lineTo(h[1][0],h[1][1]),b.lineTo(k[0],k[1]),b.lineTo(h[3][0],h[3][1]),b.lineTo(h[2][0],h[2][1]),b.lineTo(k[0],k[1])):(b.lineTo(k[0],k[1]),b.lineTo(h[2][0],h[2][1]),b.lineTo(h[3][0],h[3][1]),b.lineTo(k[0],k[1]),b.lineTo(h[1][0],h[1][1])));k||(e?(b.lineTo(h[1][0],h[1][1]),b.lineTo(h[2][0],h[2][1]),
b.lineTo(h[3][0],h[3][1])):(b.lineTo(h[3][0],h[3][1]),b.lineTo(h[2][0],h[2][1]),b.lineTo(h[1][0],h[1][1])));b.lineTo(h[0][0],h[0][1]);b.lineTo(0,0);b.lineTo(0,I.height);b.lineTo(I.width,I.height);b.lineTo(I.width,0);b.lineTo(0,0);b.fill();x(a.onFreeTransformCornerPosChange)},L=v.find("> .kPainterPerspect > .kPainterPerspectCorner");L.css("left","0");L.css("top","0");L.css("right","0");L.css("bottom","0");var K=null,H,n,p;L.on("touchstart touchcancel touchend mousedown",function(a){p=this;a.preventDefault();
var b=a.originalEvent.targetTouches;if(!b){if(!w)w="mouse";else if("mouse"!=w)return;b=[{pageX:a.originalEvent.clientX,pageY:a.originalEvent.clientY}]}else if(b.length)if(!w)w="touch";else if("touch"!=w)return;a=function(){var a=G.width()/2-5,b=G.height()/2-5,c=parseFloat(p.style.left),d=parseFloat(p.style.top),e=!0,f=!0;c<-a?c=-a:c>a?c=a:e=!1;d<-b?d=-b:d>b?d=b:f=!1;e&&(p.style.left=c+"px",p.style.right=-c+"px");f&&(p.style.top=d+"px",p.style.bottom=-d+"px");(e||f)&&P()};1==b.length?("perspect"==
C&&(C="perspectCornerMoving"),a(),K=b[0].identifier,H=b[0].pageX,n=b[0].pageY):0==b.length&&"perspectCornerMoving"==C&&(a(),w=null,C="perspect")});v.on("touchmove mousemove",function(a){a.preventDefault();var b=a.originalEvent.targetTouches;if(!b){if("mouse"!=w)return;b=[{pageX:a.originalEvent.clientX,pageY:a.originalEvent.clientY}]}else if("touch"!=w)return;if(1==b.length&&"perspectCornerMoving"==C&&K==b[0].identifier){var c=H;a=n;H=b[0].pageX;n=b[0].pageY;b=H-c;a=n-a;b=parseFloat(p.style.left)+
b;a=parseFloat(p.style.top)+a;p.style.left=b+"px";p.style.right=-b+"px";p.style.top=a+"px";p.style.bottom=-a+"px";P()}});v.on("mouseup",function(){"mouse"==w&&"perspectCornerMoving"==C&&(w=null,C="perspect")});v.on("mouseleave",function(a){"mouse"==w&&a.originalEvent.buttons&&"perspectCornerMoving"==C&&(w=null,C="perspect")});a.freeTransformMaxWH=2048;a.freeTransform=function(b,c){return new Promise(function(e,f){if(!c&&"freeTransform"!=O)return f(Error("`freeTransform`: The function is only valid in `freeTransform` mode."));
g();var k=KPainter._cv,l=b=b||N();.005>Math.abs(l[0][0]-.5)&&.005>Math.abs(l[0][1]-.5)&&.005>Math.abs(l[1][0]+.5)&&.005>Math.abs(l[1][1]-.5)&&.005>Math.abs(l[2][0]+.5)&&.005>Math.abs(l[2][1]+.5)&&.005>Math.abs(l[3][0]-.5)&&.005>Math.abs(l[3][1]+.5)?(z(),c?e(null):e()):F(c||r(a.freeTransformMaxWH),a.freeTransformMaxWH,function(a){a=new k.matFromArray(a,k.CV_8UC4);k.cvtColor(a,a,k.ColorConversionCodes.COLOR_RGBA2RGB.value,0);for(var f=new k.Mat.zeros(4,1,k.CV_32FC2),g=f.data32f(),l=0;l<b.length;++l){var m=
b[l];g[2*l]=Math.round((m[0]+.5)*a.cols);g[2*l+1]=Math.round((m[1]+.5)*a.rows)}var n=g[2]-g[0],p=g[3]-g[1],m=g[4]-g[2],l=g[5]-g[3],q=g[6]-g[4],t=g[7]-g[5],r=g[0]-g[6],u=g[1]-g[7],g=Math.round(Math.max(Math.sqrt(n*n+p*p),Math.sqrt(q*q+t*t))),m=Math.round(Math.max(Math.sqrt(m*m+l*l),Math.sqrt(r*r+u*u))),r=new k.Mat.zeros(4,1,k.CV_32FC2),l=r.data32f();l[2]=g;l[4]=g;l[5]=m;l[7]=m;l=k.getPerspectiveTransform(f,r);k.delMat(f);k.delMat(r);f=new k.Mat.zeros(m,g,k.CV_8UC3);r=new k.Scalar(0,255,0);k.warpPerspective(a,
f,l,[f.rows,f.cols],k.InterpolationFlags.INTER_LINEAR.value,k.BORDER_CONSTANT,r);k.delMat(a);k.delMat(l);k.delMat(r);a=new ImageData(g,m);r=f.channels();n=f.data();for(p=l=0;l<n.length;l+=r,p+=4)a.data[p]=n[l],a.data[p+1]=n[l+1%r],a.data[p+2]=n[l+2%r],a.data[p+3]=255;k.delMat(f);d.width=g;d.height=m;d.getContext("2d").putImageData(a,0,0);U.setImgStyleFit();h(d,"image/jpeg").then(function(a){c?e(a):(Q.pushStack({srcBlob:a,saveFormat:"image/jpeg"}),Q.updateCvsAsync(!0,!1,function(){T([[-.5,-.5],[.5,
-.5],[.5,.5],[-.5,.5]]);C="perspect";z();e()}))})})})};a.enterFreeTransformMode=function(){return new Promise(function(a,b){if(!y)return b(Error("`enterFreeTransformMode`: The function is only valid in edit mode."));if(!KPainter.cvHasLoaded)return b(Error("`enterFreeTransformMode`: You should call `KPainter.loadCvScript()` first before use this function."));O="";w=null;C="perspect";g();setTimeout(function(){D.hideCropRect();Q.updateCvsAsync(!0,!1,function(){T([[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]]);
G.show();z();Q.needAlwaysTrueTransform=!0;O="freeTransform";a()})},0)})};a.exitFreeTransformMode=function(){return new Promise(function(b,c){if("freeTransform"!=O)return c(Error("`exitFreeTransformMode`: It is not in `freeTransform` mode."));O="";G.hide();Q.updateCvsAsync(!1,!1,function(){a.isAutoShowCropUI&&D.showCropRect();C=w=null;Q.needAlwaysTrueTransform=!1;O="basicEdit";b()})})}})()};new function(){a.videoHtmlElement=b('<div class="kPainterVideoMdl" style="display:none;"><video class="kPainterVideo" webkit-playsinline="true"></video><select class="kPainterCameraSelect"></select><select class="kPainterResolutionSelect"><option class="kPainterGotResolutionOpt" value="got" selected></option><option data-width="3840" data-height="2160">ask 3840 x 2160</option><option data-width="1920" data-height="1080">ask 1920 x 1080</option><option data-width="1600" data-height="1200">ask 1600 x 1200</option><option data-width="1280" data-height="720">ask 1280 x 720</option><option data-width="800" data-height="600">ask 800 x 600</option><option data-width="640" data-height="480">ask 640 x 480</option><option data-width="640" data-height="360">ask 640 x 360</option></select><button class="kPainterBtnGrabVideo"><svg width="48" viewBox="0 0 2048 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1024 672q119 0 203.5 84.5t84.5 203.5-84.5 203.5-203.5 84.5-203.5-84.5-84.5-203.5 84.5-203.5 203.5-84.5zm704-416q106 0 181 75t75 181v896q0 106-75 181t-181 75h-1408q-106 0-181-75t-75-181v-896q0-106 75-181t181-75h224l51-136q19-49 69.5-84.5t103.5-35.5h512q53 0 103.5 35.5t69.5 84.5l51 136h224zm-704 1152q185 0 316.5-131.5t131.5-316.5-131.5-316.5-316.5-131.5-316.5 131.5-131.5 316.5 131.5 316.5 316.5 131.5z"/></svg></button><button class="kPainterBtnCloseVideo"><svg width="48" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"/></svg></button></div>')[0];
a.videoSettings={video:{facingMode:{ideal:"environment"}}};a.beforeAddImgFromGrabVideoBtn=null;a.afterAddImgFromGrabVideoBtn=null;a.grabVideo=null;a.hideVideo=null;a.showVideo=function(c){a.hideVideo&&a.hideVideo();var d=b(a.videoHtmlElement).find(".kPainterVideo")[0],e=b(a.videoHtmlElement).find(".kPainterCameraSelect")[0],g=b(a.videoHtmlElement).find(".kPainterResolutionSelect")[0],h=b(a.videoHtmlElement).find(".kPainterGotResolutionOpt")[0],r=b(a.videoHtmlElement).find(".kPainterBtnGrabVideo")[0],
u=b(a.videoHtmlElement).find(".kPainterBtnCloseVideo")[0],w=function(){return e?navigator.mediaDevices.enumerateDevices().then(function(a){var b=e.value;e.innerHTML="";for(var c=void 0,g=0;g<a.length;++g){var h=a[g];if("videoinput"==h.kind){var n=document.createElement("option");n.value=h.deviceId;n.innerText=h.label||"camera "+g;e.appendChild(n);b==h.deviceId&&(c=n)}}var k=e.childNodes;if(!c&&k.length)try{d.srcObject.getTracks().forEach(function(a){if("video"==a.kind)for(var b=0;b<k.length;++b){var d=
k[b];if(a.label==d.innerText)throw c=d,"found the using source";}})}catch(A){self.kConsoleLog&&self.kConsoleLog(A)}c&&(e.value=c.value)}):Promise.reject("no camera select")},v=function(){d.srcObject&&(self.kConsoleLog&&self.kConsoleLog("======stop video========"),d.srcObject.getTracks().forEach(function(a){a.stop()}))},y=function(n){return new Promise(function(p,f){v();self.kConsoleLog&&self.kConsoleLog("======before video========");var m=c?c:a.videoSettings,l=g?b(g).children(":selected")[0]:null;
if(l&&l.hasAttribute("data-width")){var q=l.getAttribute("data-width"),l=l.getAttribute("data-height");h.setAttribute("data-width",q);h.setAttribute("data-height",l);/Safari/.test(navigator.userAgent)&&/iPhone/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)?1280<=q?m.video.width=1280:640<=q?m.video.width=640:320<=q&&(m.video.width=320):(m.video.width={ideal:q},m.video.height={ideal:l});!n&&(q=b(e).children(":selected")[0])&&(n=q.value);n&&(m.video.facingMode=void 0,m.video.deviceId=
{exact:n})}var k=!1,r=function(){self.kConsoleLog&&self.kConsoleLog("======try getUserMedia========");self.kConsoleLog&&self.kConsoleLog("ask "+JSON.stringify(m.video.width)+"x"+JSON.stringify(m.video.height));navigator.mediaDevices.getUserMedia(m).then(function(a){self.kConsoleLog&&self.kConsoleLog("======get video========");return new Promise(function(b,c){d.srcObject=a;d.onloadedmetadata=function(){self.kConsoleLog&&self.kConsoleLog("======play video========");d.play().then(function(){self.kConsoleLog&&
self.kConsoleLog("======played video========");var a=d.videoWidth+"x"+d.videoHeight;h&&(h.innerText=a);g&&(g.value="got");self.kConsoleLog&&self.kConsoleLog(a);b()},function(a){c(a)})};d.onerror=function(){c()}})}).then(function(){p()})["catch"](function(a){self.kConsoleLog&&self.kConsoleLog(a);k?f(a):(k=!0,m.video.width=void 0,m.video.height=void 0,r())})};r()})},z=function(){y(e.value).then(function(){F&&v()})["catch"](function(a){alert("Play video failed: "+(a.message||a))})};e&&e.addEventListener("change",
z);var C=function(){y().then(function(){F&&v()})["catch"](function(a){alert("Play video failed: "+(a.message||a))})};g&&g.addEventListener("change",C);a.grabVideo=function(b){var c=document.createElement("canvas");c.width=d.videoWidth;c.height=d.videoHeight;c.getContext("2d").drawImage(d,0,0);return b?a.addImage(c):c};var D=function(){if(a.beforeAddImgFromGrabVideoBtn){var b=a.grabVideo();x(a.beforeAddImgFromGrabVideoBtn,[b,function(b){a.addImage(b).then(function(b){x(a.afterAddImgFromGrabVideoBtn,
[!0,b])},function(b){x(a.afterAddImgFromGrabVideoBtn,[!1,b])})}])}else a.grabVideo(!0).then(function(b){x(a.afterAddImgFromGrabVideoBtn,[!0,b])},function(b){x(a.afterAddImgFromGrabVideoBtn,[!1,b])});a.hideVideo()};if(r)b(r).on("click",D);var F=!1,H=function(){v();F=!0;h.removeAttribute("data-width");var c=a.videoHtmlElement.parentNode;c&&c.removeChild(a.videoHtmlElement);e&&e.removeEventListener("change",z);g&&g.removeEventListener("change",C);r&&b(r).off("click",D);u&&b(u).off("click",H);a.grabVideo=
null;a.hideVideo=null};a.hideVideo=H;if(u)b(u).on("click",H);document.body.appendChild(a.videoHtmlElement);return y().then(function(){if(F)return v(),Promise.reject("Video window has closed.");w()["catch"](function(a){self.kConsoleLog&&kConsoleLog(a)});b(a.videoHtmlElement).show();return Promise.resolve()})}}};KPainter.cvFolder=void 0==KPainter.cvFolder?"js":KPainter.cvFolder;KPainter.cvHasLoaded=!1;
KPainter._doCallbackNoBreak=function(c,a){if(c)try{c.apply(window,a||[])}catch(b){setTimeout(function(){throw b;},0)}};
KPainter.loadCvScript=function(){return new Promise(function(c,a){KPainter._loadCvQueue=KPainter._loadCvQueue||new TaskQueue;KPainter._loadCvQueue.push(function(){if(KPainter.cvHasLoaded)c(),KPainter._loadCvQueue.next();else{KPainter._CVModule={cvFolder:KPainter.cvFolder,preRun:[],postRun:[],isRuntimeInitialized:!1,onRuntimeInitialized:function(){KPainter.cvHasLoaded=!0;self.kConsoleLog&&kConsoleLog("Runtime is ready!");c();KPainter._loadCvQueue.next()},onExit:function(){a(Error("load wasm failed."));
KPainter._loadCvQueue.next()},onAbort:function(){a(Error("load wasm failed."));KPainter._loadCvQueue.next()},print:function(a){self.kConsoleLog&&kConsoleLog(a)},printErr:function(a){self.kConsoleLog&&kConsoleLog(a)},setStatus:function(a){self.kConsoleLog&&kConsoleLog(a)},totalDependencies:0};KPainter._CVModule.setStatus("Downloading...");var b=document.createElement("script"),h=KPainter.cvFolder;"/"!=h.charAt(h.length-1)&&(h+="/");b.src=window.WebAssembly?h+"cv-wasm.js?v=20180921":h+"cv.js?v=201800921";
b.onerror=function(){a(Error("load script failed."));KPainter._loadCvQueue.next()};document.body.appendChild(b)}})})};var MBC=KPainter;
